<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Newsletter Builder Pro - Inside the Sphere</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Montserrat:wght@300;400;500;600&family=Crimson+Text:wght@400;600&family=Raleway:wght@300;400;500&family=Lora:wght@400;500&family=Cormorant+Garamond:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #f39c12;
            --primary-dark: #e67e22;
            --secondary-color: #27ae60;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --info-color: #3498db;
            --border-color: #e0e0e0;
            --background-dark: #2c3e50;
            --background-light: #f8f9fa;
            --background-card: #ffffff;
            --text-light: #2c3e50;
            --text-muted: #666666;
            --text-secondary: #999999;
            --text-dark: #2c3e50;
            --border-radius: 8px;
            --box-shadow: 0 4px 12px rgba(243, 156, 18, 0.1);
            --transition: all 0.3s ease;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: var(--background-light);
            color: var(--text-light);
            min-height: 100vh;
            line-height: 1.5;
        }

        /* Main Content Section */
        .main-content {
            padding: 40px 20px;
            background: var(--background-light);
            min-height: 100vh;
        }

        .content-container {
            max-width: 1600px;
            margin: 0 auto;
        }

        /* Dashboard Layout */
        .dashboard-container {
            display: grid;
            grid-template-columns: 500px 1fr;
            gap: 30px;
            margin-top: 20px;
        }

        .sidebar {
            background: var(--background-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            overflow-y: auto;
            max-height: 90vh;
            position: sticky;
            top: 20px;
            box-shadow: var(--box-shadow);
        }

        .preview-container {
            background: var(--background-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px;
            overflow-y: auto;
            max-height: 90vh;
            position: sticky;
            top: 20px;
            box-shadow: var(--box-shadow);
        }

        /* App Header */
        .app-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 30px 25px;
            text-align: center;
        }

        .app-header h1 {
            font-family: 'Playfair Display', serif;
            font-size: 26px;
            font-weight: 400;
            margin-bottom: 10px;
            letter-spacing: 1px;
        }

        .app-header .subtitle {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .app-header .edition-badge {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 5px;
            font-size: 12px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        /* Form Sections */
        .form-content {
            padding: 30px 25px;
        }

        .form-section {
            margin-bottom: 35px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 25px;
            background: var(--background-card);
        }

        .form-section__header {
            color: var(--primary-color);
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-section__header::before {
            content: '';
            width: 4px;
            height: 20px;
            background: var(--primary-color);
            border-radius: 2px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group__label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-muted);
            font-size: 13px;
        }

        .form-group__input,
        .form-group__textarea,
        .form-group__select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 14px;
            font-family: 'Montserrat', sans-serif;
            transition: var(--transition);
            background: var(--background-card);
            color: var(--text-light);
            min-height: 44px;
        }

        .form-group__select {
            background: var(--background-card);
            color: var(--text-light);
        }

        .form-group__select option {
            background: var(--background-card);
            color: var(--text-light);
            padding: 8px;
        }

        .form-group__input:focus,
        .form-group__textarea:focus,
        .form-group__select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(243, 156, 18, 0.1);
            transform: translateY(-1px);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: var(--background-card);
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 12px 15px;
            transition: var(--transition);
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 44px;
        }

        .stat-item:focus-within {
            border-color: var(--primary-color);
        }

        .stat-item__label {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--text-muted);
            font-weight: 600;
            letter-spacing: 0.5px;
            margin: 0;
            flex: 1;
        }

        .stat-item__input {
            border: none;
            padding: 0;
            font-size: 15px;
            font-weight: 600;
            color: var(--primary-color);
            background: transparent;
            text-align: right;
            width: 100px;
            flex-shrink: 0;
        }

        .stat-item__input:focus {
            outline: 1px solid var(--primary-color);
            border-radius: 4px;
            padding: 4px;
        }

        /* Buttons */
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 13px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            min-height: 44px;
            justify-content: center;
            text-decoration: none;
        }

        .btn:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        .btn--primary {
            background: var(--primary-color);
            color: white;
        }

        .btn--primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(243, 156, 18, 0.3);
        }

        .btn--secondary {
            background: #666666;
            color: white;
        }

        .btn--success {
            background: var(--success-color);
            color: white;
        }

        .btn--info {
            background: var(--info-color);
            color: white;
        }

        .btn--full {
            width: 100%;
            justify-content: center;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay--show {
            display: flex;
        }

        .modal {
            background: var(--background-card);
            border: 1px solid var(--border-color);
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            min-width: 300px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            box-shadow: var(--box-shadow);
            animation: slideIn 0.3s ease-out;
            position: relative;
            overflow: hidden;
        }

        .toast--success { background: var(--success-color); }
        .toast--error { background: var(--danger-color); }
        .toast--warning { background: var(--warning-color); }
        .toast--info { background: var(--info-color); }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Preview Styles */
        .preview-header {
            background: var(--background-light);
            padding: 25px;
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .preview-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        .newsletter-preview {
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--box-shadow);
            max-width: 700px;
            margin: 0 auto 20px auto;
            color: var(--text-dark);
        }

        /* Event Items */
        .event-item {
            background: var(--background-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
        }

        .event-delete {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 44px;
            min-height: 44px;
        }

        .image-preview {
            display: flex;
            align-items: center;
            padding: 10px;
            background: var(--background-light);
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        .required-field::after {
            content: ' *';
            color: var(--danger-color);
            font-weight: bold;
        }

        .validation-message {
            font-size: 12px;
            margin-top: 5px;
            display: none;
            line-height: 1.4;
        }

        .validation-message.error {
            color: var(--danger-color);
            display: block;
        }

        .validation-message.success {
            color: var(--success-color);
            display: block;
        }

        /* Compatibility Warning */
        .compatibility-warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 2px solid #ff9800;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            color: #856404;
        }

        .compatibility-warning h4 {
            color: #856404;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .compatibility-warning ul {
            color: #856404;
            margin: 0;
            padding-left: 20px;
        }

        .compatibility-info {
            background: #d1ecf1;
            border: 2px solid #17a2b8;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            color: #0c5460;
        }

        /* Mobile Responsive */
        @media (max-width: 1023px) {
            .dashboard-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .sidebar {
                height: auto;
                max-height: none;
                position: static;
            }
            
            .preview-container {
                position: static;
                max-height: none;
            }

            .form-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }

        @media (max-width: 767px) {
            .main-content {
                padding: 30px 10px;
            }
            
            .form-content {
                padding: 20px 15px;
            }
            
            .form-section {
                padding: 15px;
                margin-bottom: 20px;
            }
            
            .preview-actions {
                flex-direction: column;
                gap: 10px;
            }
            
            .preview-actions .btn {
                width: 100%;
            }
        }

        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeInUp 0.8s ease;
        }

        /* File input styling */
        .form-group__input[type="file"] {
            padding: 8px 15px;
            cursor: pointer;
        }

        .form-group__input[type="file"]::-webkit-file-upload-button {
            background: var(--primary-color);
            color: #000;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            margin-right: 10px;
            font-size: 12px;
            cursor: pointer;
        }

        /* Color input styling */
        .form-group__input[type="color"] {
            height: 44px;
            padding: 4px;
        }

        /* Enhanced select dropdown styling for light theme */
        .form-group__select {
            cursor: pointer;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23f39c12' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 40px;
        }

        /* Firefox specific select styling */
        @-moz-document url-prefix() {
            .form-group__select {
                background: var(--background-card);
                color: var(--text-light);
            }
        }

        /* Section headers in stats */
        .stats-section-header {
            font-size: 13px;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Quick color buttons */
        .quick-color-btn {
            width: 30px;
            height: 30px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            transition: var(--transition);
        }

        .quick-color-btn:hover {
            transform: scale(1.1);
            border-color: var(--primary-color);
        }

        small {
            color: var(--text-secondary);
            font-size: 11px;
        }

        /* Emoji picker styles */
        .emoji-btn {
            background: none;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 8px 10px;
            font-size: 18px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .emoji-btn:hover {
            background: var(--background-light);
            border-color: var(--primary-color);
            transform: scale(1.1);
        }

        .emoji-btn:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Export Modal -->
    <div class="modal-overlay" id="exportModal">
        <div class="modal">
            <h3 style="margin-bottom: 20px; font-size: 20px; color: var(--primary-color);">📧 Export Newsletter</h3>
            
            <div class="compatibility-warning">
                <h4>✅ Email Client Compatibility</h4>
                <ul style="margin: 10px 0; font-size: 13px; line-height: 1.4;">
                    <li>All images are automatically uploaded to Imgur for perfect email compatibility</li>
                    <li>Newsletter uses hosted image URLs - works in all email clients</li>
                    <li>No blocked images or deliverability issues</li>
                    <li>Always test in your target email clients before sending</li>
                    <li>Professional hosting ensures images load reliably</li>
                </ul>
            </div>
            
            <div class="compatibility-info">
                <h4>📊 Email Client Support</h4>
                <div>
                    ✅ <strong>Gmail:</strong> Excellent support<br>
                    ✅ <strong>Apple Mail:</strong> Best support
                </div>
            </div>

            <div class="compatibility-info">
                <h4>🖨️ Print Optimization</h4>
                <div>
                    <strong>Print Version:</strong> Optimized for standard letter paper (8.5" x 11")<br>
                    <strong>Features:</strong> Proper margins, page breaks, black & white friendly<br>
                    <strong>Best For:</strong> Client handouts, office distribution, archival copies
                </div>
            </div>
            
            <div style="display: grid; gap: 10px; margin-top: 20px;">
                <button class="btn btn--primary" onclick="exportManager.copyEmailSafeHTML()">
                    📧 Copy Newsletter for email
                </button>
                <button class="btn btn--success" onclick="exportManager.exportAsHTML()">
                    📄 Download HTML File (Hosted URLs)
                </button>
                <button class="btn btn--info" onclick="exportManager.printNewsletter()">
                    🖨️ Print Newsletter
                </button>
                <button class="btn btn--secondary" onclick="modalManager.close('exportModal')">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Add Event Modal -->
    <div class="modal-overlay" id="addEventModal">
        <div class="modal">
            <h3 style="margin-bottom: 20px; color: var(--primary-color);">Add Event</h3>
            <form id="addEventForm">
                <div class="form-group">
                    <label class="form-group__label required-field">Event Title</label>
                    <input type="text" class="form-group__input" id="eventTitle" required>
                    <div class="validation-message" id="eventTitle-validation"></div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-group__label required-field">Date</label>
                        <input type="date" class="form-group__input" id="eventDate" required>
                        <div class="validation-message" id="eventDate-validation"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-group__label">Start Time</label>
                        <input type="time" class="form-group__input" id="eventStartTime">
                        <div class="validation-message" id="eventStartTime-validation"></div>
                        <small>Optional - leave blank for all-day events</small>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-group__label">End Time</label>
                    <input type="time" class="form-group__input" id="eventEndTime">
                    <div class="validation-message" id="eventEndTime-validation"></div>
                    <small>Optional - leave blank if no specific end time</small>
                </div>
                <div class="form-group">
                    <label class="form-group__label">Location</label>
                    <input type="text" class="form-group__input" id="eventLocation">
                    <div class="validation-message" id="eventLocation-validation"></div>
                    <small>Optional - leave blank for online events or TBA</small>
                </div>
                <div class="form-group">
                    <label class="form-group__label">Description (Optional)</label>
                    <textarea class="form-group__textarea" id="eventDescription" rows="3"></textarea>
                    <div class="validation-message" id="eventDescription-validation"></div>
                </div>
                <div class="form-group">
                    <label class="form-group__label">Event Details Link (Optional)</label>
                    <input type="url" class="form-group__input" id="eventDetailsLink" placeholder="https://example.com/event-details">
                    <div class="validation-message" id="eventDetailsLink-validation"></div>
                    <small>Optional - link to registration page, more details, or event website</small>
                </div>
                <div class="form-group">
                    <label class="form-group__label">Event Image (Optional)</label>
                    <input type="file" class="form-group__input" id="eventImage" accept="image/*" onchange="handleEventImageUpload()">
                    <div class="image-preview" id="eventImagePreview" style="margin-top: 10px; display: none;">
                        <img style="width: 120px; height: 80px; object-fit: cover; border-radius: 4px; border: 2px solid #ddd;">
                        <button type="button" onclick="removeEventImage()" style="margin-left: 10px; padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">Remove</button>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn--primary" style="flex: 1;">Add Event</button>
                    <button type="button" class="btn btn--secondary" onclick="modalManager.close('addEventModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Custom Property Type Modal -->
    <div class="modal-overlay" id="addCustomPropertyTypeModal">
        <div class="modal">
            <h3 style="margin-bottom: 20px; color: var(--primary-color);">Add Custom Property Type</h3>
            <form id="addCustomPropertyTypeForm">
                <div class="form-group">
                    <label class="form-group__label required-field">Property Type Name</label>
                    <input type="text" class="form-group__input" id="customPropertyTypeName" required placeholder="e.g., Luxury Condos, Mobile Homes, etc.">
                    <div class="validation-message" id="customPropertyTypeName-validation"></div>
                </div>
                <div class="form-group">
                    <label class="form-group__label">Property Type Icon</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" class="form-group__input" id="customPropertyTypeIcon" placeholder="🏘️" maxlength="2" style="flex: 1;">
                        <button type="button" class="btn btn--info" onclick="toggleCustomPropertyEmojiPicker()" style="padding: 12px 16px;" title="Pick Emoji">
                            😊
                        </button>
                    </div>
                    <div class="validation-message" id="customPropertyTypeIcon-validation"></div>
                    <small>Optional - single emoji to represent this property type</small>
                    
                    <!-- Emoji Picker for Custom Property -->
                    <div id="customPropertyEmojiPicker" style="display: none; margin-top: 10px; padding: 15px; background: var(--background-card); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: var(--box-shadow);">
                        <div style="margin-bottom: 10px;">
                            <strong style="color: var(--primary-color); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">🏠 Houses & Buildings</strong>
                            <div style="display: flex; gap: 5px; flex-wrap: wrap; margin-top: 5px;">
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🏠')">🏠</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🏡')">🏡</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🏘️')">🏘️</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🏢')">🏢</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🏬')">🏬</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🏭')">🏭</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🏗️')">🏗️</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🏚️')">🏚️</button>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            <strong style="color: var(--primary-color); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">🏰 Special Properties</strong>
                            <div style="display: flex; gap: 5px; flex-wrap: wrap; margin-top: 5px;">
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🏰')">🏰</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🏯')">🏯</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🗼')">🗼</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🕌')">🕌</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('⛪')">⛪</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🏛️')">🏛️</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🏟️')">🏟️</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🎪')">🎪</button>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            <strong style="color: var(--primary-color); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">🏕️ Outdoor & Recreation</strong>
                            <div style="display: flex; gap: 5px; flex-wrap: wrap; margin-top: 5px;">
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🏕️')">🏕️</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('⛺')">⛺</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🏞️')">🏞️</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🏖️')">🏖️</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🏝️')">🏝️</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('⛰️')">⛰️</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🏔️')">🏔️</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🗻')">🗻</button>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            <strong style="color: var(--primary-color); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">🚗 Transportation & Access</strong>
                            <div style="display: flex; gap: 5px; flex-wrap: wrap; margin-top: 5px;">
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🚗')">🚗</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🚙')">🚙</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🏎️')">🏎️</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🚐')">🚐</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🚛')">🚛</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🚌')">🚌</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🚂')">🚂</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('✈️')">✈️</button>
                            </div>
                        </div>
                        
                        <div>
                            <strong style="color: var(--primary-color); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">💎 Luxury & Premium</strong>
                            <div style="display: flex; gap: 5px; flex-wrap: wrap; margin-top: 5px;">
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('💎')">💎</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('👑')">👑</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🌟')">🌟</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('⭐')">⭐</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('✨')">✨</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🔥')">🔥</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('💰')">💰</button>
                                <button type="button" class="emoji-btn" onclick="insertCustomPropertyEmoji('🏆')">🏆</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn--primary" style="flex: 1;">Add Property Type</button>
                    <button type="button" class="btn btn--secondary" onclick="modalManager.close('addCustomPropertyTypeModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Manage Maintenance Tips Modal -->
    <div class="modal-overlay" id="maintenanceTipsModal">
        <div class="modal">
            <h3 style="margin-bottom: 20px; color: var(--primary-color);">🔧 Manage Maintenance Tips</h3>
            
            <div style="margin-bottom: 20px; padding: 15px; background: var(--background-light); border: 1px solid var(--border-color); border-radius: 6px;">
                <strong style="color: var(--primary-color);">Current Month: </strong>
                <span id="modalCurrentMonth" style="text-transform: capitalize;"></span>
            </div>
            
            <div id="modalMaintenanceTipsList" style="margin-bottom: 20px; max-height: 300px; overflow-y: auto;">
                <!-- Maintenance tips will be rendered here -->
            </div>
            
            <div class="form-group">
                <label class="form-group__label">Add New Tip</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" class="form-group__input" id="modalNewMaintenanceTip" placeholder="Enter a new maintenance tip..." style="flex: 1;">
                    <button type="button" class="btn btn--info" onclick="toggleModalEmojiPicker()" style="padding: 12px 16px;" title="Add Emoji">
                        😊
                    </button>
                    <button type="button" class="btn btn--primary" onclick="addModalMaintenanceTip()" style="padding: 12px 20px;">
                        Add Tip
                    </button>
                </div>
                
                <!-- Emoji Picker -->
                <div id="modalEmojiPicker" style="display: none; margin-top: 10px; padding: 15px; background: var(--background-card); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: var(--box-shadow);">
                    <div style="margin-bottom: 10px;">
                        <strong style="color: var(--primary-color); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">🔧 Tools & Maintenance</strong>
                        <div style="display: flex; gap: 5px; flex-wrap: wrap; margin-top: 5px;">
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('🔧')">🔧</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('🔨')">🔨</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('🪚')">🪚</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('⚒️')">⚒️</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('🧰')">🧰</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('⚙️')">⚙️</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('🔩')">🔩</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('⚡')">⚡</button>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 10px;">
                        <strong style="color: var(--primary-color); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">🏠 Home & Garden</strong>
                        <div style="display: flex; gap: 5px; flex-wrap: wrap; margin-top: 5px;">
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('🏠')">🏠</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('🏡')">🏡</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('🪟')">🪟</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('🚪')">🚪</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('🌿')">🌿</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('🌱')">🌱</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('🌳')">🌳</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('🌺')">🌺</button>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 10px;">
                        <strong style="color: var(--primary-color); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">🌦️ Weather & Seasons</strong>
                        <div style="display: flex; gap: 5px; flex-wrap: wrap; margin-top: 5px;">
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('❄️')">❄️</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('🌨️')">🌨️</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('☀️')">☀️</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('🌧️')">🌧️</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('💨')">💨</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('🍂')">🍂</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('🌡️')">🌡️</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('🧊')">🧊</button>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 10px;">
                        <strong style="color: var(--primary-color); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">💧 Utilities & Safety</strong>
                        <div style="display: flex; gap: 5px; flex-wrap: wrap; margin-top: 5px;">
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('💧')">💧</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('🚿')">🚿</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('🔥')">🔥</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('💡')">💡</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('🚨')">🚨</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('🧹')">🧹</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('🧽')">🧽</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('🧴')">🧴</button>
                        </div>
                    </div>
                    
                    <div>
                        <strong style="color: var(--primary-color); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">📋 Tasks & Reminders</strong>
                        <div style="display: flex; gap: 5px; flex-wrap: wrap; margin-top: 5px;">
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('📋')">📋</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('✅')">✅</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('📝')">📝</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('📅')">📅</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('⏰')">⏰</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('🔔')">🔔</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('⚠️')">⚠️</button>
                            <button type="button" class="emoji-btn" onclick="insertModalEmoji('🎯')">🎯</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 20px; padding: 15px; background: var(--background-light); border: 1px solid var(--border-color); border-radius: 6px;">
                <button type="button" class="btn btn--secondary btn--full" onclick="resetToDefaultTips()" style="margin-bottom: 10px;">
                    🔄 Reset to Default Seasonal Tips
                </button>
                <small style="display: block; text-align: center; color: var(--text-muted);">This will restore the original tips for the selected month and remove all custom tips</small>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="button" class="btn btn--primary" onclick="modalManager.close('maintenanceTipsModal')" style="flex: 1;">Done</button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <section class="main-content">
        <div class="content-container">
            <div class="dashboard-container">
                <!-- Sidebar -->
                <div class="sidebar">
                    <div class="app-header">
                        <h1>Newsletter Builder Pro</h1>
                        <p class="subtitle">Enhanced Real Estate Marketing</p>
                        <div class="edition-badge">
                            <strong id="currentMonth">June 2025 Edition</strong><br>
                            <small>🚀 Production Ready</small>
                        </div>
                    </div>
                    
                    <div class="form-content">
                        <!-- Month & Banner Design -->
                        <div class="form-section fade-in">
                            <h3 class="form-section__header">🎨 Month & Banner Design</h3>
                            <div class="form-group">
                                <label class="form-group__label">Newsletter Month</label>
                                <select class="form-group__select" id="newsletterSeason">
                                    <option value="january">January - New Beginnings</option>
                                    <option value="february">February - Love Your Home</option>
                                    <option value="march">March - Spring Prep</option>
                                    <option value="april">April - Spring Awakening</option>
                                    <option value="may">May - Blooming Season</option>
                                    <option value="june" selected>June - Summer Starts</option>
                                    <option value="july">July - Summer Living</option>
                                    <option value="august">August - Late Summer</option>
                                    <option value="september">September - Fall Prep</option>
                                    <option value="october">October - Autumn Comfort</option>
                                    <option value="november">November - Thanksgiving Season</option>
                                    <option value="december">December - Holiday Season</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-group__label">Banner Style</label>
                                <select class="form-group__select" id="bannerStyle">
                                    <option value="mountains" selected>Mountains</option>
                                    <option value="cityscape">City Skyline</option>
                                    <option value="blueprint">Blueprint</option>
                                    <option value="minimal">Clean Minimal</option>
                                    <option value="custom">Custom Banner Image</option>
                                    <option value="none">No Banner</option>
                                </select>
                            </div>
                            
                            <!-- Custom Banner Upload -->
                            <div class="form-group" id="customBannerUpload" style="display: none;">
                                <label class="form-group__label">Custom Banner Image</label>
                                <input type="file" class="form-group__input" id="customBanner" accept="image/*" onchange="handleImageUpload('customBanner', 'customBanner')">
                                <div class="image-preview" id="customBannerPreview" style="margin-top: 10px; display: none;">
                                    <img style="width: 200px; height: 100px; object-fit: cover; border: 2px solid #ddd; border-radius: 4px;">
                                    <button type="button" onclick="removeImage('customBanner', 'customBanner')" style="margin-left: 10px; padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">Remove</button>
                                </div>
                                <small>📏 Recommended size: 600x300px or similar landscape ratio</small>
                                
                                <div style="margin-top: 15px; padding: 15px; background: var(--background-light); border: 1px solid var(--border-color); border-radius: 6px;">
                                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin: 0;">
                                        <input type="checkbox" id="hideCustomBannerText" onchange="handleFormChange('hideCustomBannerText', this.checked)" style="width: 18px; height: 18px;">
                                        <div style="flex: 1;">
                                            <div style="font-weight: 500; color: var(--text-light); font-size: 14px;">Hide banner text overlay</div>
                                            <div style="font-size: 12px; color: var(--text-muted); margin-top: 2px;">Remove the month/newsletter title text from your custom banner</div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-group__label">Header Font</label>
                                    <select class="form-group__select" id="headerFont">
                                        <option value="'Playfair Display', serif" selected>Playfair Display</option>
                                        <option value="'Cormorant Garamond', serif">Cormorant Garamond</option>
                                        <option value="'Lora', serif">Lora</option>
                                        <option value="'Crimson Text', serif">Crimson Text</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-group__label">Body Font</label>
                                    <select class="form-group__select" id="bodyFont">
                                        <option value="'Montserrat', sans-serif" selected>Montserrat</option>
                                        <option value="'Raleway', sans-serif">Raleway</option>
                                        <option value="'Helvetica Neue', sans-serif">Helvetica Neue</option>
                                        <option value="Arial, sans-serif">Arial</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Global Design Colors -->
                            <div style="margin-top: 25px; padding: 20px; background: var(--background-light); border: 1px solid var(--border-color); border-radius: 8px;">
                                <h4 style="color: var(--primary-color); font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                                    🎨 Color Themes
                                </h4>
                                
                                <div class="form-row" style="margin-bottom: 15px;">
                                    <div class="form-group">
                                        <label class="form-group__label">Header Text Color</label>
                                        <div style="display: flex; gap: 10px; align-items: center;">
                                            <input type="color" class="form-group__input" id="headerTextColor" value="#333333" onchange="handleFormChange('headerTextColor', this.value)" style="width: 60px; padding: 4px;">
                                            <input type="text" class="form-group__input" id="headerTextColorHex" value="#333333" oninput="handleColorHexChange('headerTextColor', 'headerTextColor', this.value)" placeholder="#333333" style="flex: 1; font-family: monospace;">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-group__label">Body Text Color</label>
                                        <div style="display: flex; gap: 10px; align-items: center;">
                                            <input type="color" class="form-group__input" id="bodyTextColor" value="#555555" onchange="handleFormChange('bodyTextColor', this.value)" style="width: 60px; padding: 4px;">
                                            <input type="text" class="form-group__input" id="bodyTextColorHex" value="#555555" oninput="handleColorHexChange('bodyTextColor', 'bodyTextColor', this.value)" placeholder="#555555" style="flex: 1; font-family: monospace;">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-row" style="margin-bottom: 15px;">
                                    <div class="form-group">
                                        <label class="form-group__label">Accent Color</label>
                                        <div style="display: flex; gap: 10px; align-items: center;">
                                            <input type="color" class="form-group__input" id="accentColor" value="#f39c12" onchange="handleFormChange('accentColor', this.value)" style="width: 60px; padding: 4px;">
                                            <input type="text" class="form-group__input" id="accentColorHex" value="#f39c12" oninput="handleColorHexChange('accentColor', 'accentColor', this.value)" placeholder="#f39c12" style="flex: 1; font-family: monospace;">
                                        </div>
                                        <small>Used for borders, highlights, and emphasis</small>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-group__label">Background Accent</label>
                                        <div style="display: flex; gap: 10px; align-items: center;">
                                            <input type="color" class="form-group__input" id="backgroundAccent" value="#f8f9fa" onchange="handleFormChange('backgroundAccent', this.value)" style="width: 60px; padding: 4px;">
                                            <input type="text" class="form-group__input" id="backgroundAccentHex" value="#f8f9fa" oninput="handleColorHexChange('backgroundAccent', 'backgroundAccent', this.value)" placeholder="#f8f9fa" style="flex: 1; font-family: monospace;">
                                        </div>
                                        <small>Background for message boxes and sections</small>
                                    </div>
                                </div>
                                
                                <!-- Quick Preset Colors -->
                                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                                    <h5 style="color: var(--text-muted); font-size: 11px; font-weight: 600; text-transform: uppercase; margin-bottom: 10px;">Quick Color Presets (8 Available)</h5>
                                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                        <button type="button" onclick="applyColorPreset('default')" class="quick-color-btn" style="background: linear-gradient(45deg, #f39c12, #e67e22); border: 2px solid #ddd;" title="Default Orange"></button>
                                        <button type="button" onclick="applyColorPreset('blue')" class="quick-color-btn" style="background: linear-gradient(45deg, #3498db, #2980b9); border: 2px solid #ddd;" title="Professional Blue"></button>
                                        <button type="button" onclick="applyColorPreset('green')" class="quick-color-btn" style="background: linear-gradient(45deg, #27ae60, #229954); border: 2px solid #ddd;" title="Nature Green"></button>
                                        <button type="button" onclick="applyColorPreset('purple')" class="quick-color-btn" style="background: linear-gradient(45deg, #9b59b6, #8e44ad); border: 2px solid #ddd;" title="Luxury Purple"></button>
                                        <button type="button" onclick="applyColorPreset('red')" class="quick-color-btn" style="background: linear-gradient(45deg, #e74c3c, #c0392b); border: 2px solid #ddd;" title="Bold Red"></button>
                                        <button type="button" onclick="applyColorPreset('teal')" class="quick-color-btn" style="background: linear-gradient(45deg, #1abc9c, #16a085); border: 2px solid #ddd;" title="Modern Teal"></button>
                                        <button type="button" onclick="applyColorPreset('dark')" class="quick-color-btn" style="background: linear-gradient(45deg, #2c3e50, #34495e); border: 2px solid #ddd;" title="Corporate Dark"></button>
                                        <button type="button" onclick="applyColorPreset('gold')" class="quick-color-btn" style="background: linear-gradient(45deg, #f1c40f, #f39c12); border: 2px solid #ddd;" title="Premium Gold"></button>
                                    </div>
                                </div>
                                
                                <!-- Royal LePage Brand Button -->
                                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                                    <button type="button" onclick="applyColorPreset('royallepage')" class="btn" style="width: 100%; background: white; border: 2px solid #003087; color: #003087; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; padding: 15px 20px; display: flex; align-items: center; justify-content: center; gap: 12px; transition: all 0.3s ease; cursor: pointer;" onmouseover="this.style.background='#f8f9fa'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(0,48,135,0.2)'" onmouseout="this.style.background='white'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                        <img src="https://i.imgur.com/5q2V1qG.png" style="height: 24px; width: auto; object-fit: contain;" alt="Royal LePage Logo">
                                        Apply Royal LePage Branding
                                        <img src="https://i.imgur.com/5q2V1qG.png" style="height: 24px; width: auto; object-fit: contain;" alt="Royal LePage Logo">
                                    </button>
                                    <div style="text-align: center; margin-top: 8px;">
                                        <small style="color: var(--text-muted); font-size: 11px;">Instantly applies official Royal LePage colors across your entire newsletter</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Personal Message -->
                        <div class="form-section fade-in">
                            <h3 class="form-section__header">💬 Personal Message</h3>
                            <div class="form-group">
                                <label class="form-group__label">Custom Subtitle</label>
                                <input type="text" class="form-group__input" id="customSubtitle" value="SUMMER STARTS" placeholder="Enter custom subtitle...">
                                <div class="validation-message" id="customSubtitle-validation"></div>
                                <small>Leave blank to use default seasonal subtitle</small>
                            </div>
                            <div class="form-group">
                                <label class="form-group__label required-field">Opening Message</label>
                                <textarea class="form-group__textarea" id="personalMessage" rows="4" required>With school winding down and the sun heating up, June is a top month for real estate. Let's make your next move a smooth one.</textarea>
                                <div class="validation-message" id="personalMessage-validation"></div>
                                <small>Minimum 50 characters, maximum 500 characters</small>
                            </div>
                        </div>
                        
                        <!-- Smart Buttons -->
                        <div class="form-section fade-in">
                            <h3 class="form-section__header">🔗 Smart Buttons</h3>
                            <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 20px;">
                                Use Smart Buttons to quickly add clickable links to your newsletter. Just copy and paste any website URL to instantly direct readers to your website, buyer or seller guides, blogs, or any resource you choose. Simple, practical, and effective.
                            </p>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-group__label">🔘 Smart Button 1 Name</label>
                                    <input type="text" class="form-group__input" id="buyersGuideName" value="Button 1" oninput="handleFormChange('buyersGuideName', this.value)" placeholder="Button 1">
                                    <div class="validation-message" id="buyersGuideName-validation"></div>
                                </div>
                                <div class="form-group">
                                    <label class="form-group__label">Smart Button 1 URL</label>
                                    <input type="url" class="form-group__input" id="buyersGuideUrl" value="" oninput="handleFormChange('buyersGuideUrl', this.value)" placeholder="https://example.com/button1">
                                    <div class="validation-message" id="buyersGuideUrl-validation"></div>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-group__label">🔘 Smart Button 2 Name</label>
                                    <input type="text" class="form-group__input" id="sellersGuideName" value="Button 2" oninput="handleFormChange('sellersGuideName', this.value)" placeholder="Button 2">
                                    <div class="validation-message" id="sellersGuideName-validation"></div>
                                </div>
                                <div class="form-group">
                                    <label class="form-group__label">Smart Button 2 URL</label>
                                    <input type="url" class="form-group__input" id="sellersGuideUrl" value="" oninput="handleFormChange('sellersGuideUrl', this.value)" placeholder="https://example.com/button2">
                                    <div class="validation-message" id="sellersGuideUrl-validation"></div>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-group__label">🔘 Smart Button 3 Name</label>
                                    <input type="text" class="form-group__input" id="websiteName" value="Button 3" oninput="handleFormChange('websiteName', this.value)" placeholder="Button 3">
                                    <div class="validation-message" id="websiteName-validation"></div>
                                </div>
                                <div class="form-group">
                                    <label class="form-group__label">Smart Button 3 URL</label>
                                    <input type="url" class="form-group__input" id="myWebsiteUrl" value="" oninput="handleFormChange('myWebsiteUrl', this.value)" placeholder="https://example.com/button3">
                                    <div class="validation-message" id="myWebsiteUrl-validation"></div>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-group__label">🔘 Smart Button 4 Name</label>
                                    <input type="text" class="form-group__input" id="blogName" value="Button 4" oninput="handleFormChange('blogName', this.value)" placeholder="Button 4">
                                    <div class="validation-message" id="blogName-validation"></div>
                                </div>
                                <div class="form-group">
                                    <label class="form-group__label">Smart Button 4 URL</label>
                                    <input type="url" class="form-group__input" id="blogUrl" value="" oninput="handleFormChange('blogUrl', this.value)" placeholder="https://example.com/button4">
                                    <div class="validation-message" id="blogUrl-validation"></div>
                                </div>
                            </div>
                            
                            <!-- Button Color Customization -->
                            <div style="margin-top: 25px; padding: 20px; background: var(--background-light); border: 1px solid var(--border-color); border-radius: 8px;">
                                <h4 style="color: var(--primary-color); font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                                    🎨 Smart Button Colors
                                </h4>
                                
                                <div class="form-row" style="margin-bottom: 10px;">
                                    <div class="form-group">
                                        <label class="form-group__label">Smart Button 1</label>
                                        <div style="display: flex; gap: 10px; align-items: center;">
                                            <input type="color" class="form-group__input" id="buyersGuideColor" value="#f39c12" onchange="handleFormChange('buyersGuideColor', this.value)" style="width: 50px; padding: 2px;">
                                            <input type="text" class="form-group__input" id="buyersGuideColorHex" value="#f39c12" oninput="handleColorHexChange('buyersGuideColor', 'buyersGuideColor', this.value)" style="flex: 1; font-family: monospace;">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-group__label">Smart Button 2</label>
                                        <div style="display: flex; gap: 10px; align-items: center;">
                                            <input type="color" class="form-group__input" id="sellersGuideColor" value="#2c3e50" onchange="handleFormChange('sellersGuideColor', this.value)" style="width: 50px; padding: 2px;">
                                            <input type="text" class="form-group__input" id="sellersGuideColorHex" value="#2c3e50" oninput="handleColorHexChange('sellersGuideColor', 'sellersGuideColor', this.value)" style="flex: 1; font-family: monospace;">
                                        </div>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-group__label">Smart Button 3</label>
                                        <div style="display: flex; gap: 10px; align-items: center;">
                                            <input type="color" class="form-group__input" id="websiteColor" value="#27ae60" onchange="handleFormChange('websiteColor', this.value)" style="width: 50px; padding: 2px;">
                                            <input type="text" class="form-group__input" id="websiteColorHex" value="#27ae60" oninput="handleColorHexChange('websiteColor', 'websiteColor', this.value)" style="flex: 1; font-family: monospace;">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-group__label">Smart Button 4</label>
                                        <div style="display: flex; gap: 10px; align-items: center;">
                                            <input type="color" class="form-group__input" id="blogColor" value="#3498db" onchange="handleFormChange('blogColor', this.value)" style="width: 50px; padding: 2px;">
                                            <input type="text" class="form-group__input" id="blogColorHex" value="#3498db" oninput="handleColorHexChange('blogColor', 'blogColor', this.value)" style="flex: 1; font-family: monospace;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Market Statistics -->
                        <div class="form-section fade-in">
                            <h3 class="form-section__header">📊 Market Statistics</h3>
                            <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 20px;">
                                Enter your market statistics manually. The system will organize them into a professional layout.
                            </p>
                            
                            <div class="stats-grid" id="statsGrid">
                                <!-- Stats will be rendered here -->
                            </div>
                            
                            <!-- Custom Property Types Container -->
                            <div id="customPropertyTypesContainer">
                                <!-- Custom property types will be rendered here -->
                            </div>
                            
                            <button type="button" class="btn" onclick="modalManager.show('addCustomPropertyTypeModal')" style="margin: 20px 0; width: 100%; background: #f39c12; color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 13px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; justify-content: center; gap: 8px; min-height: 44px;" onmouseover="this.style.background='#e67e22'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(243, 156, 18, 0.3)'" onmouseout="this.style.background='#f39c12'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                + Add Custom Property Type
                            </button>
                            
                            <!-- Property Type Color Customization -->
                            <div style="margin: 25px 0; padding: 20px; background: var(--background-light); border: 1px solid var(--border-color); border-radius: 8px;">
                                <h4 style="color: var(--primary-color); font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                                    🎨 Property Type Colors
                                </h4>
                                
                                <div class="form-row" style="margin-bottom: 10px;">
                                    <div class="form-group">
                                        <label class="form-group__label">🏠 Detached Homes</label>
                                        <div style="display: flex; gap: 10px; align-items: center;">
                                            <input type="color" class="form-group__input" id="detachedColor" value="#f39c12" onchange="handleFormChange('detachedColor', this.value)" style="width: 50px; padding: 2px;">
                                            <input type="text" class="form-group__input" id="detachedColorHex" value="#f39c12" oninput="handleColorHexChange('detachedColor', 'detachedColor', this.value)" style="flex: 1; font-family: monospace;">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-group__label">🏘️ Semi-Detached</label>
                                        <div style="display: flex; gap: 10px; align-items: center;">
                                            <input type="color" class="form-group__input" id="semiColor" value="#2c3e50" onchange="handleFormChange('semiColor', this.value)" style="width: 50px; padding: 2px;">
                                            <input type="text" class="form-group__input" id="semiColorHex" value="#2c3e50" oninput="handleColorHexChange('semiColor', 'semiColor', this.value)" style="flex: 1; font-family: monospace;">
                                        </div>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-group__label">🏘️ Row/Townhomes</label>
                                        <div style="display: flex; gap: 10px; align-items: center;">
                                            <input type="color" class="form-group__input" id="rowColor" value="#27ae60" onchange="handleFormChange('rowColor', this.value)" style="width: 50px; padding: 2px;">
                                            <input type="text" class="form-group__input" id="rowColorHex" value="#27ae60" oninput="handleColorHexChange('rowColor', 'rowColor', this.value)" style="flex: 1; font-family: monospace;">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-group__label">🏢 Apartments/Condos</label>
                                        <div style="display: flex; gap: 10px; align-items: center;">
                                            <input type="color" class="form-group__input" id="apartmentColor" value="#3498db" onchange="handleFormChange('apartmentColor', this.value)" style="width: 50px; padding: 2px;">
                                            <input type="text" class="form-group__input" id="apartmentColorHex" value="#3498db" oninput="handleColorHexChange('apartmentColor', 'apartmentColor', this.value)" style="flex: 1; font-family: monospace;">
                                        </div>
                                    </div>
                                </div>
                                <div style="margin-top: 15px;">
                                    <div class="form-group">
                                        <label class="form-group__label">Custom Property Types</label>
                                        <div style="display: flex; gap: 10px; align-items: center;">
                                            <input type="color" class="form-group__input" id="customPropertyColor" value="#9b59b6" onchange="handleFormChange('customPropertyColor', this.value)" style="width: 50px; padding: 2px;">
                                            <input type="text" class="form-group__input" id="customPropertyColorHex" value="#9b59b6" oninput="handleColorHexChange('customPropertyColor', 'customPropertyColor', this.value)" style="flex: 1; font-family: monospace;">
                                        </div>
                                        <small>Color used for all custom property types you add</small>
                                    </div>
                                </div>
                            </div>
                            
                            <hr style="border: none; border-top: 1px solid var(--border-color); margin: 20px 0;">
                            <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 15px;">
                                📄 Optional call-to-action smart button after market analysis
                            </p>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-group__label">Smart Button Text (Optional)</label>
                                    <input type="text" class="form-group__input" id="marketButtonText" value="" oninput="handleFormChange('marketButtonText', this.value)" placeholder="View Full Market Report">
                                    <div class="validation-message" id="marketButtonText-validation"></div>
                                </div>
                                <div class="form-group">
                                    <label class="form-group__label">Smart Button URL (Optional)</label>
                                    <input type="url" class="form-group__input" id="marketButtonUrl" value="" oninput="handleFormChange('marketButtonUrl', this.value)" placeholder="https://example.com/market-report">
                                    <div class="validation-message" id="marketButtonUrl-validation"></div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-group__label">Smart Button Color</label>
                                    <div style="display: flex; gap: 10px; align-items: center;">
                                        <input type="color" class="form-group__input" id="marketButtonColor" value="#f39c12" onchange="handleFormChange('marketButtonColor', this.value)" style="width: 50px; padding: 2px;">
                                        <input type="text" class="form-group__input" id="marketButtonColorHex" value="#f39c12" oninput="handleColorHexChange('marketButtonColor', 'marketButtonColor', this.value)" style="flex: 1; font-family: monospace;">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <!-- Empty space for alignment -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Monthly Maintenance Tips -->
                        <div class="form-section fade-in">
                            <h3 class="form-section__header">🔧 Monthly Maintenance Tips</h3>
                            <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 15px;">
                                Manage maintenance tips for the selected month. Tips automatically update when you change months.
                            </p>
                            
                            <div id="maintenanceTipsSummary" style="margin-bottom: 20px; padding: 15px; background: var(--background-light); border: 1px solid var(--border-color); border-radius: 6px;">
                                <!-- Summary will be rendered here -->
                            </div>
                            
                            <button type="button" class="btn btn--primary btn--full" onclick="openMaintenanceTipsModal()">
                                🔧 Manage Maintenance Tips
                            </button>
                        </div>
                        
                        <!-- Community Calendar & Events -->
                        <div class="form-section fade-in">
                            <h3 class="form-section__header">📅 Community Calendar & Events</h3>
                            <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 15px;">
                                Add your community events with optional images automatically hosted on Imgur for email compatibility.
                            </p>
                            <button type="button" class="btn btn--primary btn--full" onclick="modalManager.show('addEventModal')">
                                + Add Event
                            </button>
                            <div id="customEventsList" style="margin-top: 15px;">
                                <!-- Custom events will appear here -->
                            </div>
                        </div>
                        
                        <!-- Your Information -->
                        <div class="form-section fade-in">
                            <h3 class="form-section__header">👤 Your Information</h3>
                            <div class="form-group">
                                <label class="form-group__label required-field">Full Name</label>
                                <input type="text" class="form-group__input" id="agentName" value="" required>
                                <div class="validation-message" id="agentName-validation"></div>
                            </div>
                            <div class="form-group">
                                <label class="form-group__label required-field">Company Name</label>
                                <input type="text" class="form-group__input" id="companyName" value="" required>
                                <div class="validation-message" id="companyName-validation"></div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-group__label required-field">Phone</label>
                                    <input type="tel" class="form-group__input" id="agentPhone" value="" required>
                                    <div class="validation-message" id="agentPhone-validation"></div>
                                </div>
                                <div class="form-group">
                                    <label class="form-group__label required-field">Email</label>
                                    <input type="email" class="form-group__input" id="agentEmail" value="" required>
                                    <div class="validation-message" id="agentEmail-validation"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-group__label required-field">Website</label>
                                <input type="url" class="form-group__input" id="agentWebsite" value="" required>
                                <div class="validation-message" id="agentWebsite-validation"></div>
                            </div>
                            
                            <hr style="border: none; border-top: 1px solid var(--border-color); margin: 20px 0;">
                            <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 15px;">
                                📷 Upload your professional photos and logos (automatically hosted on Imgur)
                            </p>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-group__label">Agent Photo</label>
                                    <input type="file" class="form-group__input" id="agentPhoto" accept="image/*" onchange="handleImageUpload('agentPhoto', 'agentPhoto')">
                                    <div class="image-preview" id="agentPhotoPreview" style="margin-top: 10px; display: none;">
                                        <img style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid #ddd;">
                                        <button type="button" onclick="removeImage('agentPhoto', 'agentPhoto')" style="margin-left: 10px; padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">Remove</button>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-group__label">Agent Logo</label>
                                    <input type="file" class="form-group__input" id="agentLogo" accept="image/*" onchange="handleImageUpload('agentLogo', 'agentLogo')">
                                    <div class="image-preview" id="agentLogoPreview" style="margin-top: 10px; display: none;">
                                        <img style="width: 80px; height: 60px; object-fit: contain; border: 2px solid #ddd; border-radius: 4px;">
                                        <button type="button" onclick="removeImage('agentLogo', 'agentLogo')" style="margin-left: 10px; padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">Remove</button>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-group__label">Brokerage Logo</label>
                                <input type="file" class="form-group__input" id="brokerageLogo" accept="image/*" onchange="handleImageUpload('brokerageLogo', 'brokerageLogo')">
                                <div class="image-preview" id="brokerageLogoPreview" style="margin-top: 10px; display: none;">
                                    <img style="width: 120px; height: 60px; object-fit: contain; border: 2px solid #ddd; border-radius: 4px;">
                                    <button type="button" onclick="removeImage('brokerageLogo', 'brokerageLogo')" style="margin-left: 10px; padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">Remove</button>
                                </div>
                            </div>
                        </div>
                        
                        <button class="btn btn--primary btn--full" onclick="generateNewsletter()" style="font-size: 16px; padding: 16px 24px;">
                            ✨ Generate Newsletter
                        </button>
                    </div>
                </div>

                <!-- Preview Container -->
                <div class="preview-container">
                    <div class="preview-header">
                        <button onclick="toggleInstructionsPopup()" class="btn btn--primary" style="font-size: 14px; padding: 12px 24px;">
                            📖 Quick User Guide
                        </button>
                        
                        <!-- Instructions Popup -->
                        <div id="instructionsPopup" style="display: none; margin-top: 20px; padding: 20px; background: white; border: 2px solid var(--primary-color); border-radius: 12px; text-align: left; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
                            <h3 style="color: var(--primary-color); margin-bottom: 15px; font-size: 18px;">🚀 Quick Start Guide</h3>
                            
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: var(--text-light); font-size: 14px; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                                    <span style="background: var(--primary-color); color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">1</span>
                                    Choose Your Month & Style
                                </h4>
                                <p style="margin: 0 0 0 32px; font-size: 13px; color: var(--text-muted); line-height: 1.4;">Select your newsletter month and banner style. Try the Royal LePage branding button for instant professional colors!</p>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: var(--text-light); font-size: 14px; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                                    <span style="background: var(--primary-color); color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">2</span>
                                    Add Your Personal Message
                                </h4>
                                <p style="margin: 0 0 0 32px; font-size: 13px; color: var(--text-muted); line-height: 1.4;">Write your opening message and customize Smart Buttons by adding URLs to your website, guides, or resources.</p>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: var(--text-light); font-size: 14px; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                                    <span style="background: var(--primary-color); color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">3</span>
                                    Enter Market Statistics
                                </h4>
                                <p style="margin: 0 0 0 32px; font-size: 13px; color: var(--text-muted); line-height: 1.4;">Fill in your local market data. You can edit property type names, add custom types, and customize colors.</p>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: var(--text-light); font-size: 14px; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                                    <span style="background: var(--primary-color); color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">4</span>
                                    Add Events & Your Information
                                </h4>
                                <p style="margin: 0 0 0 32px; font-size: 13px; color: var(--text-muted); line-height: 1.4;">Include community events with images, update maintenance tips, and fill in your contact information and photos.</p>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: var(--text-light); font-size: 14px; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                                    <span style="background: var(--primary-color); color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">5</span>
                                    Generate & Export
                                </h4>
                                <p style="margin: 0 0 0 32px; font-size: 13px; color: var(--text-muted); line-height: 1.4;">Click "Generate Newsletter" to see your preview, then use "Export Options" to copy for email, download HTML, or print.</p>
                            </div>
                            
                            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                                <p style="margin: 0; font-size: 12px; color: var(--text-muted); text-align: center; font-style: italic;">
                                    💡 Tip: Use Ctrl/Cmd + Enter to quickly generate your newsletter at any time!
                                </p>
                            </div>
                            
                            <div style="text-align: center; margin-top: 15px;">
                                <button onclick="toggleInstructionsPopup()" style="background: var(--primary-color); color: white; border: none; border-radius: 6px; padding: 10px 20px; cursor: pointer; font-size: 13px; font-weight: 500;">
                                    Got it! 👍
                                </button>
                            </div>
                        </div>
                        
                        <p style="color: var(--text-muted); margin-top: 15px; font-size: 14px;">
                            <span id="previewStatus">📝 Start filling out the form to see your newsletter preview</span>
                        </p>
                    </div>
                    
                    <div class="newsletter-preview" id="newsletterPreview">
                        <!-- Newsletter content will be generated here -->
                    </div>
                    
                    <div class="preview-actions" style="padding-bottom: 20px;">
                        <button class="btn btn--secondary" onclick="quickPrint()">
                            🖨️ Print
                        </button>
                        <button class="btn btn--primary" onclick="modalManager.show('exportModal')">
                            📧 Export Options
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script>
        // Global state
        let newsletterData = {
            design: {
                bannerStyle: 'mountains',
                headerFont: "'Playfair Display', serif",
                bodyFont: "'Montserrat', sans-serif",
                hideCustomBannerText: false,
                colors: {
                    headerText: '#333333',
                    bodyText: '#555555',
                    accent: '#f39c12',
                    background: '#f8f9fa'
                },
            defaultPropertyTypes: [
                {
                    id: 'detached',
                    name: 'Detached Homes',
                    icon: '🏠',
                    colorKey: 'detached',
                    required: false
                },
                {
                    id: 'semi',
                    name: 'Semi-Detached',
                    icon: '🏘️',
                    colorKey: 'semi',
                    required: false
                },
                {
                    id: 'row',
                    name: 'Row/Townhomes',
                    icon: '🏘️',
                    colorKey: 'row',
                    required: false
                },
                {
                    id: 'apartment',
                    name: 'Apartments/Condos',
                    icon: '🏢',
                    colorKey: 'apartment',
                    required: false
                }
            ],
                buttonColors: {
                    buyersGuide: '#f39c12',
                    sellersGuide: '#2c3e50',
                    website: '#27ae60',
                    blog: '#3498db',
                    marketReport: '#f39c12',
                    eventDetails: '#f39c12'
                },
                propertyTypeColors: {
                    detached: '#f39c12',
                    semi: '#2c3e50',
                    row: '#27ae60',
                    apartment: '#3498db',
                    custom: '#9b59b6'
                }
            },
            images: {
                currentEventImage: null,
                agentPhoto: null,
                agentLogo: null,
                brokerageLogo: null,
                customBanner: null
            },
            stats: {
                avgPrice: '$589,900',
                priceChange: '-2.5%',
                homesSold: '2,568',
                salesChange: '-16.9%',
                newListings: '4,842',
                listingsChange: '+11.6%',
                inventory: '6,740',
                inventoryChange: '+97.5%',
                monthsOfSupply: '2.62',
                supplyChange: '+137.7%',
                
                detachedPrice: '$769,400',
                detachedChange: '+1.0%',
                detachedSales: '1,275',
                detachedSalesChange: '-8%',
                detachedListings: '2,419',
                detachedListingsChange: '+19%',
                detachedInventory: '2,995',
                detachedInventoryChange: '+87%',
                detachedSupply: '2.35',
                
                semiPrice: '$697,300',
                semiChange: '+2.8%',
                semiSales: '256',
                semiSalesChange: '-1%',
                semiListings: '428',
                semiListingsChange: '+19%',
                semiInventory: '542',
                semiInventoryChange: '+99%',
                semiSupply: '2.12',
                
                rowPrice: '$453,600',
                rowChange: '-1.9%',
                rowSales: '458',
                rowSalesChange: '-15%',
                rowListings: '764',
                rowListingsChange: '+11%',
                rowInventory: '1,116',
                rowInventoryChange: '+161%',
                rowSupply: '2.44',
                
                apartmentPrice: '$335,300',
                apartmentChange: '-1.5%',
                apartmentSales: '579',
                apartmentSalesChange: '-36%',
                apartmentListings: '1,231',
                apartmentListingsChange: '-2%',
                apartmentInventory: '2,087',
                apartmentInventoryChange: '+88%',
                apartmentSupply: '3.60'
            },
            agent: {
                name: '',
                company: '',
                phone: '',
                email: '',
                website: '',
                // Smart Button settings - simplified to just names and URLs
                smartButtons: {
                    buyersGuide: {
                        name: 'Button 1',
                        url: ''
                    },
                    sellersGuide: {
                        name: 'Button 2', 
                        url: ''
                    },
                    website: {
                        name: 'Button 3',
                        url: ''
                    },
                    blog: {
                        name: 'Button 4',
                        url: ''
                    }
                }
            },
            content: {
                personalMessage: 'With school winding down and the sun heating up, June is a top month for real estate. Let\'s make your next move a smooth one.',
                newsletterSeason: 'june',
                customSubtitle: 'SUMMER STARTS',
                marketButtonText: '',
                marketButtonUrl: ''
            },
            customPropertyTypes: [],
            customEvents: [],
            maintenanceTips: [
                '❄️ Test A/C and change filters',
                '🌧️ Check eavestrough slope and extension', 
                '🔧 Inspect fence posts for shifting',
                '🪟 Wash windows and inspect screens',
                '💨 Secure patio furniture before windstorms'
            ]
        };

        // Season configurations
        const SEASONS = {
            january: {
                title: 'JANUARY NEWSLETTER',
                subtitle: 'NEW BEGINNINGS',
                personalMessage: 'Happy New Year! A fresh start brings new opportunities—whether it\'s upgrading your space or buying your first home. Let\'s make 2025 the year of great moves!',
                tips: ['🔧 Replace furnace filter', '💧 Use humidifier to combat dry air', '🧊 Watch for ice dams after Chinooks', '❄️ Check for frost in attic/basement', '🚨 Test smoke & CO detectors']
            },
            february: {
                title: 'FEBRUARY NEWSLETTER',
                subtitle: 'LOVE YOUR HOME',
                personalMessage: 'Love is in the air—and so is opportunity! Whether you\'re buying, selling, or just curious, I\'m here to help you find a home you\'ll love.',
                tips: ['🌨️ Clear snow from foundation & vents', '🚪 Inspect weather stripping after freeze-thaw', '🔐 Lubricate locks & garage mechanisms', '💧 Monitor for condensation inside windows', '⚡ Test sump pump for early thaw']
            },
            march: {
                title: 'MARCH NEWSLETTER',
                subtitle: 'SPRING PREP',
                personalMessage: 'As the snow melts and days grow longer, now\'s the time to start thinking spring market. Real estate is warming up—are you ready?',
                tips: ['☀️ Begin clearing snow from perimeter', '💧 Check grading for pooling meltwater', '🏠 Book roof inspection before spring rain', '🌳 Trim snow-damaged tree limbs', '🌱 Prep garden tools & order supplies']
            },
            april: {
                title: 'APRIL NEWSLETTER',
                subtitle: 'SPRING AWAKENING',
                personalMessage: 'Spring is in full swing! It\'s a great time to freshen up your home or explore new listings. Let\'s talk about what\'s happening in your area.',
                tips: ['🌧️ Clean gutters/downspouts', '🏠 Inspect shingles & siding for winter damage', '💧 Test exterior taps (after final frost)', '🔧 Caulk windows and doors', '🌿 Fertilize lawn (spring mix)']
            },
            may: {
                title: 'MAY NEWSLETTER',
                subtitle: 'BLOOMING SEASON',
                personalMessage: 'May is for patios, gardening, and maybe even new beginnings. If you\'ve been thinking of a move, the spring market is buzzing!',
                tips: ['🚿 Power wash siding, deck, walkways', '💧 Inspect irrigation system for leaks', '🔧 Reseal driveway and deck surfaces', '🍖 Clean BBQ and prep outdoor living space', '🐛 Monitor for signs of pests and insects']
            },
            june: {
                title: 'JUNE NEWSLETTER',
                subtitle: 'SUMMER STARTS',
                personalMessage: 'With school winding down and the sun heating up, June is a top month for real estate. Let\'s make your next move a smooth one.',
                tips: ['❄️ Test A/C and change filters', '🌧️ Check eavestrough slope and extension', '🔧 Inspect fence posts for shifting', '🪟 Wash windows and inspect screens', '💨 Secure patio furniture before windstorms']
            },
            july: {
                title: 'JULY NEWSLETTER',
                subtitle: 'SUMMER LIVING',
                personalMessage: 'It\'s summer fun and sunshine! The market\'s still active, and I\'m here to help you take the next step—whether you\'re buying or selling.',
                tips: ['🌳 Trim trees near home (hail + wind risk)', '🏠 Check attic insulation and ventilation', '☀️ Use UV films or blinds on sunny windows', '💧 Water lawn early mornings (drought)', '🔥 Inspect dryer vent (fire safety)']
            },
            august: {
                title: 'AUGUST NEWSLETTER',
                subtitle: 'LATE SUMMER',
                personalMessage: 'Before fall routines kick in, August is the perfect time to make a move or prep your home for sale. Let\'s chat about your next step!',
                tips: ['🏠 Review roof for hail damage', '🔥 Prep furnace for fall (early servicing)', '🧹 Deep clean garage or shed', '📋 Plan fall landscaping or repairs', '🎨 Touch up exterior paint']
            },
            september: {
                title: 'SEPTEMBER NEWSLETTER',
                subtitle: 'FALL PREP',
                personalMessage: 'As routines return and leaves begin to turn, it\'s a great time to revisit your real estate goals. Fall can be full of opportunity!',
                tips: ['💧 Blow out sprinklers before frost', '🌿 Fertilize lawn (fall mix)', '🔥 Inspect chimney and fireplace', '📦 Store summer tools and patio gear', '🐭 Check attic and garage for rodent entry']
            },
            october: {
                title: 'OCTOBER NEWSLETTER',
                subtitle: 'AUTUMN COMFORT',
                personalMessage: 'Fall is here and so is one of the coziest times to shop for a new place. Let\'s talk listings, market trends, or your real estate wish list!',
                tips: ['❄️ Winterize outdoor faucets and hoses', '🍂 Rake and compost leaves', '🏠 Inspect foundation for cracks', '🔥 Test heating system and thermostat', '🚪 Apply weather seal to doors/windows']
            },
            november: {
                title: 'NOVEMBER NEWSLETTER',
                subtitle: 'THANKSGIVING SEASON',
                personalMessage: 'Before the holiday rush, November is a great time to review your plans. Thinking of a move in the new year? Let\'s get ahead of it together.',
                tips: ['❄️ Prepare snow removal equipment', '❄️ Cover or store A/C units', '💡 Install exterior light timers', '🧊 Stock ice melt and emergency supplies', '🔧 Replace furnace filter']
            },
            december: {
                title: 'DECEMBER NEWSLETTER',
                subtitle: 'HOLIDAY SEASON',
                personalMessage: 'Wishing you a warm and peaceful holiday season! Whether you\'re cozy at home or planning a change in the new year, I\'m here when you need me.',
                tips: ['❄️ Clear snow from roof edges and vents', '🚨 Test CO detectors during peak furnace use', '💨 Check for drafts around windows', '🚶 Keep exits and walkways snow-free', '🏠 Inspect roof load if heavy snowfalls occur']
            }
        };

        // Imgur API integration (Note: In production, you'd want proper error handling)
        const IMGUR_CLIENT_ID = '203a7e94de049ff';
        
        async function uploadToImgur(file, imageKey) {
            // Note: Due to Claude artifact limitations, Imgur upload won't work
            // This is a mock implementation
            showToast('📤 Image upload simulated (Imgur not available in this environment)', 'info', 3000);
            
            // Create a local URL for preview purposes
            const localUrl = URL.createObjectURL(file);
            newsletterData.images[imageKey] = localUrl;
            
            updatePreview();
            return localUrl;
        }

        // Time formatting helper
        function formatEventTime(startTime, endTime) {
            if (!startTime) return '';
            
            function formatTime(timeStr) {
                const [hours, minutes] = timeStr.split(':');
                const hour12 = hours % 12 || 12;
                const ampm = hours >= 12 ? 'PM' : 'AM';
                return `${hour12}:${minutes} ${ampm}`;
            }
            
            const formattedStart = formatTime(startTime);
            
            if (endTime) {
                const formattedEnd = formatTime(endTime);
                return `${formattedStart} - ${formattedEnd}`;
            }
            
            return formattedStart;
        }

        // Date formatting helper
        function formatEventDate(dateString) {
            const [year, month, day] = dateString.split('-');
            const monthNames = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 
                               'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
            return {
                month: monthNames[parseInt(month) - 1],
                day: parseInt(day)
            };
        }

        // Image handling functions
        function handleImageUpload(inputId, imageKey) {
            const input = document.getElementById(inputId);
            const file = input.files[0];
            
            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    showToast('❌ Image size must be less than 5MB', 'error');
                    input.value = '';
                    return;
                }
                
                showImagePreview(inputId, null, 'uploading');
                
                uploadToImgur(file, imageKey).then(imgurUrl => {
                    if (imgurUrl) {
                        showImagePreview(inputId, imgurUrl, 'success');
                    } else {
                        document.getElementById(inputId + 'Preview').style.display = 'none';
                        input.value = '';
                    }
                });
            }

            // Add maintenance tip on Enter key (modal version)
            document.addEventListener('keypress', (e) => {
                if (e.target.id === 'modalNewMaintenanceTip' && e.key === 'Enter') {
                    e.preventDefault();
                    // Close emoji picker if open before adding tip
                    document.getElementById('modalEmojiPicker').style.display = 'none';
                    addModalMaintenanceTip();
                }
            });
        }

        function showImagePreview(inputId, imageSrc, status = 'success') {
            const preview = document.getElementById(inputId + 'Preview');
            const img = preview.querySelector('img');
            
            if (status === 'uploading') {
                preview.style.display = 'block';
                img.style.opacity = '0.5';
                img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iNDAiIGN5PSI0MCIgcj0iMzAiIHN0cm9rZT0iI2RkZCIgc3Ryb2tlLXdpZHRoPSI0Ii8+Cjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSIgZm9udC1zaXplPSIxMiIgZmlsbD0iIzk5OSI+4oGq4oGq4oGq8J+TpDwvdGV4dD4KPC9zdmc+';
            } else if (status === 'success' && imageSrc) {
                img.style.opacity = '1';
                img.src = imageSrc;
                preview.style.display = 'block';
            }
            
            const statusDiv = preview.querySelector('.upload-status') || document.createElement('div');
            statusDiv.className = 'upload-status';
            statusDiv.style.cssText = 'font-size: 11px; margin-top: 5px; padding: 4px 8px; border-radius: 4px;';
            
            if (status === 'uploading') {
                statusDiv.textContent = '⏳ Uploading...';
                statusDiv.style.background = '#fff3cd';
                statusDiv.style.color = '#856404';
            } else if (status === 'success') {
                statusDiv.textContent = '✅ Image loaded';
                statusDiv.style.background = '#d4edda';
                statusDiv.style.color = '#155724';
            }
            
            if (!preview.querySelector('.upload-status')) {
                preview.appendChild(statusDiv);
            }
        }

        function removeImage(inputId, imageKey) {
            newsletterData.images[imageKey] = null;
            document.getElementById(inputId).value = '';
            document.getElementById(inputId + 'Preview').style.display = 'none';
            updatePreview();
            showToast('🗑️ Image removed', 'info');
        }

        function removeEventImage() {
            newsletterData.images.currentEventImage = null;
            document.getElementById('eventImage').value = '';
            document.getElementById('eventImagePreview').style.display = 'none';
            showToast('🗑️ Event image removed', 'info');
        }

        function handleEventImageUpload() {
            const input = document.getElementById('eventImage');
            const file = input.files[0];
            
            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    showToast('❌ Image size must be less than 5MB', 'error');
                    input.value = '';
                    return;
                }
                
                showEventImagePreview(null, 'uploading');
                
                uploadToImgur(file, 'currentEventImage').then(imgurUrl => {
                    if (imgurUrl) {
                        showEventImagePreview(imgurUrl, 'success');
                    } else {
                        document.getElementById('eventImagePreview').style.display = 'none';
                        input.value = '';
                    }
                });
            }
        }

        function showEventImagePreview(imageSrc, status = 'success') {
            const preview = document.getElementById('eventImagePreview');
            const img = preview.querySelector('img');
            
            if (status === 'uploading') {
                preview.style.display = 'block';
                img.style.opacity = '0.5';
                img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjgwIiB2aWV3Qm94PSIwIDAgMTIwIDgwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cmVjdCB3aWR0aD0iMTIwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjZjBmMGYwIiByeD0iNCIvPgo8dGV4dCB4PSI1MCUiIHk9IjUwJSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iIGZvbnQtc2l6ZT0iMTIiIGZpbGw9IiM5OTkiPuKBquKBquKBqvCfk6Q8L3RleHQ+Cjwvc3ZnPg==';
            } else if (status === 'success' && imageSrc) {
                img.style.opacity = '1';
                img.src = imageSrc;
                preview.style.display = 'block';
            }
            
            const statusDiv = preview.querySelector('.upload-status') || document.createElement('div');
            statusDiv.className = 'upload-status';
            statusDiv.style.cssText = 'font-size: 11px; margin-top: 5px; padding: 4px 8px; border-radius: 4px;';
            
            if (status === 'uploading') {
                statusDiv.textContent = '⏳ Uploading...';
                statusDiv.style.background = '#fff3cd';
                statusDiv.style.color = '#856404';
            } else if (status === 'success') {
                statusDiv.textContent = '✅ Image loaded';
                statusDiv.style.background = '#d4edda';
                statusDiv.style.color = '#155724';
            }
            
            if (!preview.querySelector('.upload-status')) {
                preview.appendChild(statusDiv);
            }
        }

        // Toast system
        function showToast(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast--${type}`;
            toast.textContent = message;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // Modal manager
        const modalManager = {
            show: (modalId) => {
                const modal = document.getElementById(modalId);
                if (modal) modal.classList.add('modal-overlay--show');
            },
            close: (modalId) => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.remove('modal-overlay--show');
                    const form = modal.querySelector('form');
                    if (form) {
                        form.reset();
                        const validationMessages = form.querySelectorAll('.validation-message');
                        validationMessages.forEach(msg => {
                            msg.style.display = 'none';
                            msg.classList.remove('error', 'success', 'warning');
                        });
                        
                        if (modalId === 'addEventModal') {
                            newsletterData.images.currentEventImage = null;
                            document.getElementById('eventImagePreview').style.display = 'none';
                            document.getElementById('eventDetailsLink').value = '';
                        }
                        
                        if (modalId === 'maintenanceTipsModal') {
                            document.getElementById('modalEmojiPicker').style.display = 'none';
                            document.getElementById('modalNewMaintenanceTip').value = '';
                        }
                        
                        if (modalId === 'addCustomPropertyTypeModal') {
                            document.getElementById('customPropertyEmojiPicker').style.display = 'none';
                        }
                    }
                }
            }
        };

        // Close modal when clicking outside
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                const modalId = e.target.id;
                modalManager.close(modalId);
            }
        });

        // Close modal emoji picker when clicking outside (only for modal)
        document.addEventListener('click', (e) => {
            // Maintenance tips modal emoji picker
            const modalPicker = document.getElementById('modalEmojiPicker');
            const modalButton = e.target.closest('[onclick="toggleModalEmojiPicker()"]');
            const isInsideModalPicker = e.target.closest('#modalEmojiPicker');
            
            if (modalPicker && !modalButton && !isInsideModalPicker) {
                modalPicker.style.display = 'none';
            }
            
            // Custom property type modal emoji picker
            const customPropertyPicker = document.getElementById('customPropertyEmojiPicker');
            const customPropertyButton = e.target.closest('[onclick="toggleCustomPropertyEmojiPicker()"]');
            const isInsideCustomPropertyPicker = e.target.closest('#customPropertyEmojiPicker');
            
            if (customPropertyPicker && !customPropertyButton && !isInsideCustomPropertyPicker) {
                customPropertyPicker.style.display = 'none';
            }
        });

        // Form handling
        function handleFormChange(fieldId, value) {
            const fieldMap = {
                'bannerStyle': 'design.bannerStyle',
                'headerFont': 'design.headerFont',
                'bodyFont': 'design.bodyFont',
                'hideCustomBannerText': 'design.hideCustomBannerText',
                'headerTextColor': 'design.colors.headerText',
                'bodyTextColor': 'design.colors.bodyText',
                'accentColor': 'design.colors.accent',
                'backgroundAccent': 'design.colors.background',
                'buyersGuideColor': 'design.buttonColors.buyersGuide',
                'sellersGuideColor': 'design.buttonColors.sellersGuide',
                'websiteColor': 'design.buttonColors.website',
                'blogColor': 'design.buttonColors.blog',
                'marketButtonColor': 'design.buttonColors.marketReport',
                'detachedColor': 'design.propertyTypeColors.detached',
                'semiColor': 'design.propertyTypeColors.semi',
                'rowColor': 'design.propertyTypeColors.row',
                'apartmentColor': 'design.propertyTypeColors.apartment',
                'customPropertyColor': 'design.propertyTypeColors.custom',
                'newsletterSeason': 'content.newsletterSeason',
                'customSubtitle': 'content.customSubtitle',
                'agentName': 'agent.name',
                'companyName': 'agent.company',
                'agentPhone': 'agent.phone',
                'agentEmail': 'agent.email',
                'agentWebsite': 'agent.website',
                'personalMessage': 'content.personalMessage',
                'marketButtonText': 'content.marketButtonText',
                'marketButtonUrl': 'content.marketButtonUrl',
                // Smart Button settings
                'buyersGuideEnabled': 'agent.smartButtons.buyersGuide.enabled',
                'buyersGuideName': 'agent.smartButtons.buyersGuide.name',
                'buyersGuideUrl': 'agent.smartButtons.buyersGuide.url',
                'sellersGuideEnabled': 'agent.smartButtons.sellersGuide.enabled',
                'sellersGuideName': 'agent.smartButtons.sellersGuide.name',
                'sellersGuideUrl': 'agent.smartButtons.sellersGuide.url',
                'websiteEnabled': 'agent.smartButtons.website.enabled',
                'websiteName': 'agent.smartButtons.website.name',
                'myWebsiteUrl': 'agent.smartButtons.website.url',
                'blogEnabled': 'agent.smartButtons.blog.enabled',
                'blogName': 'agent.smartButtons.blog.name',
                'blogUrl': 'agent.smartButtons.blog.url',
                // Stats
                'avgPrice': 'stats.avgPrice',
                'priceChange': 'stats.priceChange',
                'daysOnMarket': 'stats.daysOnMarket',
                'homesSold': 'stats.homesSold',
                'salesChange': 'stats.salesChange',
                'newListings': 'stats.newListings',
                'listingsChange': 'stats.listingsChange',
                'inventory': 'stats.inventory',
                'inventoryChange': 'stats.inventoryChange',
                'monthsOfSupply': 'stats.monthsOfSupply',
                'supplyChange': 'stats.supplyChange',
                'detachedPrice': 'stats.detachedPrice',
                'detachedChange': 'stats.detachedChange',
                'detachedSales': 'stats.detachedSales',
                'detachedSalesChange': 'stats.detachedSalesChange',
                'detachedListings': 'stats.detachedListings',
                'detachedListingsChange': 'stats.detachedListingsChange',
                'detachedInventory': 'stats.detachedInventory',
                'detachedInventoryChange': 'stats.detachedInventoryChange',
                'detachedSupply': 'stats.detachedSupply',
                'semiPrice': 'stats.semiPrice',
                'semiChange': 'stats.semiChange',
                'semiSales': 'stats.semiSales',
                'semiSalesChange': 'stats.semiSalesChange',
                'semiListings': 'stats.semiListings',
                'semiListingsChange': 'stats.semiListingsChange',
                'semiInventory': 'stats.semiInventory',
                'semiInventoryChange': 'stats.semiInventoryChange',
                'semiSupply': 'stats.semiSupply',
                'rowPrice': 'stats.rowPrice',
                'rowChange': 'stats.rowChange',
                'rowSales': 'stats.rowSales',
                'rowSalesChange': 'stats.rowSalesChange',
                'rowListings': 'stats.rowListings',
                'rowListingsChange': 'stats.rowListingsChange',
                'rowInventory': 'stats.rowInventory',
                'rowInventoryChange': 'stats.rowInventoryChange',
                'rowSupply': 'stats.rowSupply',
                'apartmentPrice': 'stats.apartmentPrice',
                'apartmentChange': 'stats.apartmentChange',
                'apartmentSales': 'stats.apartmentSales',
                'apartmentSalesChange': 'stats.apartmentSalesChange',
                'apartmentListings': 'stats.apartmentListings',
                'apartmentListingsChange': 'stats.apartmentListingsChange',
                'apartmentInventory': 'stats.apartmentInventory',
                'apartmentInventoryChange': 'stats.apartmentInventoryChange',
                'apartmentSupply': 'stats.apartmentSupply'
            };
            
            if (fieldMap[fieldId]) {
                const keys = fieldMap[fieldId].split('.');
                let obj = newsletterData;
                for (let i = 0; i < keys.length - 1; i++) {
                    obj = obj[keys[i]];
                }
                obj[keys[keys.length - 1]] = value;
            }
            
            // Handle property type colors dynamically
            if (fieldId.endsWith('Color') && !fieldId.includes('Hex') && !fieldMap[fieldId]) {
                const propertyTypeId = fieldId.replace('Color', '');
                const propertyType = newsletterData.design.defaultPropertyTypes.find(pt => pt.id === propertyTypeId);
                if (propertyType) {
                    newsletterData.design.propertyTypeColors[propertyType.colorKey || propertyType.id] = value;
                }
            }
            
            // Update corresponding hex field when color picker changes
            if (fieldId.includes('Color') && !fieldId.includes('Hex')) {
                const hexFieldId = fieldId + 'Hex';
                const hexField = document.getElementById(hexFieldId);
                if (hexField) {
                    hexField.value = value;
                }
            }
            
            if (fieldId === 'bannerStyle') {
                const customUpload = document.getElementById('customBannerUpload');
                if (value === 'custom') {
                    customUpload.style.display = 'block';
                } else {
                    customUpload.style.display = 'none';
                    newsletterData.design.hideCustomBannerText = false;
                    const checkbox = document.getElementById('hideCustomBannerText');
                    if (checkbox) checkbox.checked = false;
                }
            }
            
            if (fieldId === 'marketButtonUrl') {
                // Auto-populate button text if URL is added and text is empty
                if (value && !newsletterData.content.marketButtonText) {
                    newsletterData.content.marketButtonText = 'View Full Market Report';
                    const textField = document.getElementById('marketButtonText');
                    if (textField) {
                        textField.value = 'View Full Market Report';
                    }
                }
            }
            
            if (fieldId === 'newsletterSeason') {
                updateMonthDisplay();
                updateMaintenanceTipsForSeason(value);
                const seasonConfig = SEASONS[value];
                if (seasonConfig) {
                    if (seasonConfig.personalMessage) {
                        const messageField = document.getElementById('personalMessage');
                        if (messageField) {
                            messageField.value = seasonConfig.personalMessage;
                            newsletterData.content.personalMessage = seasonConfig.personalMessage;
                        }
                    }
                    if (seasonConfig.subtitle) {
                        const subtitleField = document.getElementById('customSubtitle');
                        if (subtitleField) {
                            subtitleField.value = seasonConfig.subtitle;
                            newsletterData.content.customSubtitle = seasonConfig.subtitle;
                        }
                    }
                }
            }
            
            updatePreview();
        }

        // Handle hex color input changes
        function handleColorHexChange(colorPickerId, fieldId, hexValue) {
            // Validate hex color format
            if (/^#[0-9A-F]{6}$/i.test(hexValue)) {
                const colorPicker = document.getElementById(colorPickerId);
                if (colorPicker) {
                    colorPicker.value = hexValue;
                }
                handleFormChange(fieldId, hexValue);
            }
        }

        // Color preset functionality
        function applyColorPreset(presetName) {
            const presets = {
                default: {
                    colors: { headerText: '#333333', bodyText: '#555555', accent: '#f39c12', background: '#f8f9fa' },
                    buttons: { buyersGuide: '#f39c12', sellersGuide: '#2c3e50', website: '#27ae60', blog: '#3498db', marketReport: '#f39c12' },
                    propertyTypes: { detached: '#f39c12', semi: '#2c3e50', row: '#27ae60', apartment: '#3498db', custom: '#9b59b6' }
                },
                blue: {
                    colors: { headerText: '#2c3e50', bodyText: '#34495e', accent: '#3498db', background: '#ebf3fd' },
                    buttons: { buyersGuide: '#3498db', sellersGuide: '#2980b9', website: '#1abc9c', blog: '#9b59b6', marketReport: '#3498db' },
                    propertyTypes: { detached: '#3498db', semi: '#2980b9', row: '#1abc9c', apartment: '#9b59b6', custom: '#8e44ad' }
                },
                green: {
                    colors: { headerText: '#27ae60', bodyText: '#2e8b57', accent: '#27ae60', background: '#e8f8f0' },
                    buttons: { buyersGuide: '#27ae60', sellersGuide: '#229954', website: '#1abc9c', blog: '#f39c12', marketReport: '#27ae60' },
                    propertyTypes: { detached: '#27ae60', semi: '#229954', row: '#1abc9c', apartment: '#f39c12', custom: '#e67e22' }
                },
                purple: {
                    colors: { headerText: '#8e44ad', bodyText: '#6c3483', accent: '#9b59b6', background: '#f4ecf7' },
                    buttons: { buyersGuide: '#9b59b6', sellersGuide: '#8e44ad', website: '#e74c3c', blog: '#f39c12', marketReport: '#9b59b6' },
                    propertyTypes: { detached: '#9b59b6', semi: '#8e44ad', row: '#e74c3c', apartment: '#f39c12', custom: '#d68910' }
                },
                red: {
                    colors: { headerText: '#c0392b', bodyText: '#922b21', accent: '#e74c3c', background: '#fdf2f2' },
                    buttons: { buyersGuide: '#e74c3c', sellersGuide: '#c0392b', website: '#f39c12', blog: '#3498db', marketReport: '#e74c3c' },
                    propertyTypes: { detached: '#e74c3c', semi: '#c0392b', row: '#f39c12', apartment: '#3498db', custom: '#9b59b6' }
                },
                teal: {
                    colors: { headerText: '#16a085', bodyText: '#138d75', accent: '#1abc9c', background: '#e8f8f5' },
                    buttons: { buyersGuide: '#1abc9c', sellersGuide: '#16a085', website: '#27ae60', blog: '#3498db', marketReport: '#1abc9c' },
                    propertyTypes: { detached: '#1abc9c', semi: '#16a085', row: '#27ae60', apartment: '#3498db', custom: '#f39c12' }
                },
                dark: {
                    colors: { headerText: '#2c3e50', bodyText: '#34495e', accent: '#95a5a6', background: '#ecf0f1' },
                    buttons: { buyersGuide: '#34495e', sellersGuide: '#2c3e50', website: '#95a5a6', blog: '#7f8c8d', marketReport: '#95a5a6' },
                    propertyTypes: { detached: '#34495e', semi: '#2c3e50', row: '#95a5a6', apartment: '#7f8c8d', custom: '#566573' }
                },
                gold: {
                    colors: { headerText: '#b7950b', bodyText: '#9a7d0a', accent: '#f1c40f', background: '#fef9e7' },
                    buttons: { buyersGuide: '#f1c40f', sellersGuide: '#f39c12', website: '#e67e22', blog: '#d35400', marketReport: '#f1c40f' },
                    propertyTypes: { detached: '#f1c40f', semi: '#f39c12', row: '#e67e22', apartment: '#d35400', custom: '#ca6f1e' }
                },
                royallepage: {
                    colors: { headerText: '#000000', bodyText: '#4D4D4D', accent: '#EA002A', background: '#FFFFFF' },
                    buttons: { buyersGuide: '#EA002A', sellersGuide: '#000000', website: '#A59D95', blog: '#C4C18E', marketReport: '#EA002A' },
                    propertyTypes: { detached: '#EA002A', semi: '#000000', row: '#A59D95', apartment: '#4D4D4D', custom: '#C4C18E' }
                }
            };
            
            const preset = presets[presetName];
            if (!preset) return;
            
            // Apply colors to data
            newsletterData.design.colors = { ...preset.colors };
            newsletterData.design.buttonColors = { ...newsletterData.design.buttonColors, ...preset.buttons };
            newsletterData.design.propertyTypeColors = { ...preset.propertyTypes };
            
            // Update UI elements
            updateColorInputs();
            updatePreview();
            
            const displayName = presetName === 'royallepage' ? 'Royal LePage' : presetName.charAt(0).toUpperCase() + presetName.slice(1);
            showToast(`🎨 Applied ${displayName} color preset!`, 'success', 3000);
        }

        // Update color input fields
        function updateColorInputs() {
            const colorFields = [
                { id: 'headerTextColor', value: newsletterData.design.colors.headerText },
                { id: 'bodyTextColor', value: newsletterData.design.colors.bodyText },
                { id: 'accentColor', value: newsletterData.design.colors.accent },
                { id: 'backgroundAccent', value: newsletterData.design.colors.background },
                { id: 'buyersGuideColor', value: newsletterData.design.buttonColors.buyersGuide },
                { id: 'sellersGuideColor', value: newsletterData.design.buttonColors.sellersGuide },
                { id: 'websiteColor', value: newsletterData.design.buttonColors.website },
                { id: 'blogColor', value: newsletterData.design.buttonColors.blog },
                { id: 'marketButtonColor', value: newsletterData.design.buttonColors.marketReport },
                { id: 'detachedColor', value: newsletterData.design.propertyTypeColors.detached },
                { id: 'semiColor', value: newsletterData.design.propertyTypeColors.semi },
                { id: 'rowColor', value: newsletterData.design.propertyTypeColors.row },
                { id: 'apartmentColor', value: newsletterData.design.propertyTypeColors.apartment },
                { id: 'customPropertyColor', value: newsletterData.design.propertyTypeColors.custom }
            ];
            
            colorFields.forEach(field => {
                const colorInput = document.getElementById(field.id);
                const hexInput = document.getElementById(field.id + 'Hex');
                
                if (colorInput) colorInput.value = field.value;
                if (hexInput) hexInput.value = field.value;
            });
        }

        // Stats rendering
        function renderStats() {
            const statsConfig = [
                { id: 'avgPrice', label: 'Total Residential Price', field: 'avgPrice', section: 'main' },
                { id: 'priceChange', label: 'Price Change Y/Y', field: 'priceChange', section: 'main' },
                { id: 'homesSold', label: 'Total Sales', field: 'homesSold', section: 'main' },
                { id: 'salesChange', label: 'Sales Change Y/Y', field: 'salesChange', section: 'main' },
                { id: 'newListings', label: 'Total New Listings', field: 'newListings', section: 'main' },
                { id: 'listingsChange', label: 'Listings Change Y/Y', field: 'listingsChange', section: 'main' },
                { id: 'inventory', label: 'Total Inventory', field: 'inventory', section: 'main' },
                { id: 'inventoryChange', label: 'Inventory Change Y/Y', field: 'inventoryChange', section: 'main' },
                { id: 'monthsOfSupply', label: 'Months of Supply', field: 'monthsOfSupply', section: 'main' },
                { id: 'supplyChange', label: 'Supply Change Y/Y', field: 'supplyChange', section: 'main' },
                
                { id: 'detachedPrice', label: 'Price', field: 'detachedPrice', section: 'detached' },
                { id: 'detachedChange', label: 'Price Change Y/Y', field: 'detachedChange', section: 'detached' },
                { id: 'detachedSales', label: 'Sales', field: 'detachedSales', section: 'detached' },
                { id: 'detachedSalesChange', label: 'Sales Change Y/Y', field: 'detachedSalesChange', section: 'detached' },
                { id: 'detachedListings', label: 'New Listings', field: 'detachedListings', section: 'detached' },
                { id: 'detachedListingsChange', label: 'Listings Change Y/Y', field: 'detachedListingsChange', section: 'detached' },
                { id: 'detachedInventory', label: 'Inventory', field: 'detachedInventory', section: 'detached' },
                { id: 'detachedSupply', label: 'Months Supply', field: 'detachedSupply', section: 'detached' },
                
                { id: 'semiPrice', label: 'Price', field: 'semiPrice', section: 'semi' },
                { id: 'semiChange', label: 'Price Change Y/Y', field: 'semiChange', section: 'semi' },
                { id: 'semiSales', label: 'Sales', field: 'semiSales', section: 'semi' },
                { id: 'semiSalesChange', label: 'Sales Change Y/Y', field: 'semiSalesChange', section: 'semi' },
                { id: 'semiListings', label: 'New Listings', field: 'semiListings', section: 'semi' },
                { id: 'semiListingsChange', label: 'Listings Change Y/Y', field: 'semiListingsChange', section: 'semi' },
                { id: 'semiInventory', label: 'Inventory', field: 'semiInventory', section: 'semi' },
                { id: 'semiSupply', label: 'Months Supply', field: 'semiSupply', section: 'semi' },
                
                { id: 'rowPrice', label: 'Price', field: 'rowPrice', section: 'row' },
                { id: 'rowChange', label: 'Price Change Y/Y', field: 'rowChange', section: 'row' },
                { id: 'rowSales', label: 'Sales', field: 'rowSales', section: 'row' },
                { id: 'rowSalesChange', label: 'Sales Change Y/Y', field: 'rowSalesChange', section: 'row' },
                { id: 'rowListings', label: 'New Listings', field: 'rowListings', section: 'row' },
                { id: 'rowListingsChange', label: 'Listings Change Y/Y', field: 'rowListingsChange', section: 'row' },
                { id: 'rowInventory', label: 'Inventory', field: 'rowInventory', section: 'row' },
                { id: 'rowSupply', label: 'Months Supply', field: 'rowSupply', section: 'row' },
                
                { id: 'apartmentPrice', label: 'Price', field: 'apartmentPrice', section: 'apartment' },
                { id: 'apartmentChange', label: 'Price Change Y/Y', field: 'apartmentChange', section: 'apartment' },
                { id: 'apartmentSales', label: 'Sales', field: 'apartmentSales', section: 'apartment' },
                { id: 'apartmentSalesChange', label: 'Sales Change Y/Y', field: 'apartmentSalesChange', section: 'apartment' },
                { id: 'apartmentListings', label: 'New Listings', field: 'apartmentListings', section: 'apartment' },
                { id: 'apartmentListingsChange', label: 'Listings Change Y/Y', field: 'apartmentListingsChange', section: 'apartment' },
                { id: 'apartmentInventory', label: 'Inventory', field: 'apartmentInventory', section: 'apartment' },
                { id: 'apartmentSupply', label: 'Months Supply', field: 'apartmentSupply', section: 'apartment' }
            ];

            const container = document.getElementById('statsGrid');
            
            const mainStats = statsConfig.filter(s => s.section === 'main');
            
            // Get active property types from the newsletterData
            const activePropertyTypes = newsletterData.design.defaultPropertyTypes.filter(pt => !pt.deleted);
            
            let sectionsHtml = `
                <div style="margin-bottom: 25px;">
                    <div class="stats-section-header">📊 Main Market Indicators</div>
                    ${mainStats.map(stat => `
                        <div class="stat-item" style="margin-bottom: 8px;">
                            <label class="stat-item__label">${stat.label}</label>
                            <input type="text" class="stat-item__input" id="${stat.id}" value="${newsletterData.stats[stat.field] || ''}" oninput="handleFormChange('${stat.id}', this.value)">
                        </div>
                    `).join('')}
                </div>
            `;
            
            // Add sections for each active property type
            activePropertyTypes.forEach(propertyType => {
                const sectionStats = statsConfig.filter(s => s.section === propertyType.id);
                if (sectionStats.length > 0) {
                    sectionsHtml += `
                        <div style="margin-bottom: 25px;">
                            <div class="stats-section-header" style="display: flex; align-items: center; justify-content: space-between; gap: 10px;">
                                <div style="display: flex; align-items: center; gap: 8px; flex: 1;">
                                    <span>${propertyType.icon}</span>
                                    <input type="text" value="${propertyType.name}" onchange="updatePropertyTypeName('${propertyType.id}', this.value)" style="background: transparent; border: none; color: var(--primary-color); font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; flex: 1; min-width: 120px;" onclick="this.select()">
                                    <button onclick="editPropertyTypeIcon('${propertyType.id}')" style="background: none; border: none; cursor: pointer; font-size: 12px; color: var(--text-muted); padding: 2px 4px;" title="Change icon">✏️</button>
                                </div>
                                <button onclick="deletePropertyType('${propertyType.id}')" style="background: var(--danger-color); color: white; border: none; border-radius: 4px; padding: 4px 8px; font-size: 11px; cursor: pointer;" title="Delete property type">Delete</button>
                            </div>
                            ${sectionStats.map(stat => `
                                <div class="stat-item" style="margin-bottom: 8px;">
                                    <label class="stat-item__label">${stat.label}</label>
                                    <input type="text" class="stat-item__input" id="${stat.id}" value="${newsletterData.stats[stat.field] || ''}" oninput="handleFormChange('${stat.id}', this.value)">
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            });
            
            container.innerHTML = sectionsHtml;
        }

        // Property type management functions
        function updatePropertyTypeName(propertyTypeId, newName) {
            const propertyType = newsletterData.design.defaultPropertyTypes.find(pt => pt.id === propertyTypeId);
            if (propertyType) {
                propertyType.name = newName.trim();
                updatePreview();
                showToast('✅ Property type name updated', 'success', 2000);
            }
        }

        function editPropertyTypeIcon(propertyTypeId) {
            const propertyType = newsletterData.design.defaultPropertyTypes.find(pt => pt.id === propertyTypeId);
            if (propertyType) {
                const newIcon = prompt(`Enter new icon for "${propertyType.name}":`, propertyType.icon);
                if (newIcon !== null && newIcon.trim() !== '') {
                    propertyType.icon = newIcon.trim();
                    renderStats();
                    updatePreview();
                    showToast('✅ Property type icon updated', 'success', 2000);
                }
            }
        }

        function deletePropertyType(propertyTypeId) {
            const propertyType = newsletterData.design.defaultPropertyTypes.find(pt => pt.id === propertyTypeId);
            if (propertyType) {
                if (confirm(`Are you sure you want to delete "${propertyType.name}"? This will remove all associated statistics.`)) {
                    // Mark as deleted instead of removing from array to preserve data structure
                    propertyType.deleted = true;
                    
                    // Clear all stats for this property type
                    const statsToDelete = [
                        `${propertyTypeId}Price`, `${propertyTypeId}Change`, `${propertyTypeId}Sales`, `${propertyTypeId}SalesChange`,
                        `${propertyTypeId}Listings`, `${propertyTypeId}ListingsChange`, `${propertyTypeId}Inventory`, 
                        `${propertyTypeId}InventoryChange`, `${propertyTypeId}Supply`
                    ];
                    
                    statsToDelete.forEach(statKey => {
                        if (newsletterData.stats[statKey]) {
                            delete newsletterData.stats[statKey];
                        }
                    });
                    
                    renderStats();
                    updatePropertyTypeColorInputs();
                    updatePreview();
                    showToast('✅ Property type deleted successfully', 'success');
                }
            }
        }

        function restorePropertyType(propertyTypeId) {
            const propertyType = newsletterData.design.defaultPropertyTypes.find(pt => pt.id === propertyTypeId);
            if (propertyType) {
                propertyType.deleted = false;
                renderStats();
                updatePropertyTypeColorInputs();
                updatePreview();
                showToast('✅ Property type restored', 'success');
            }
        }

        // Update the property type color inputs to show only active types
        function updatePropertyTypeColorInputs() {
            const activePropertyTypes = newsletterData.design.defaultPropertyTypes.filter(pt => !pt.deleted);
            
            // Find the property type colors section
            const propertyColorsSection = document.querySelector('[style*="Property Type Colors"]')?.parentElement;
            if (propertyColorsSection) {
                const colorInputsContainer = propertyColorsSection.querySelector('.form-row').parentElement;
                
                // Generate HTML for active property types
                let propertyTypeColorInputs = '';
                const rows = [];
                
                for (let i = 0; i < activePropertyTypes.length; i += 2) {
                    const pt1 = activePropertyTypes[i];
                    const pt2 = activePropertyTypes[i + 1];
                    
                    let rowHtml = '<div class="form-row">';
                    
                    if (pt1) {
                        rowHtml += `
                            <div class="form-group">
                                <label class="form-group__label">${pt1.icon} ${pt1.name}</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="color" class="form-group__input" id="${pt1.id}Color" value="${newsletterData.design.propertyTypeColors[pt1.colorKey]}" onchange="handleFormChange('${pt1.id}Color', this.value)" style="width: 50px; padding: 2px;">
                                    <input type="text" class="form-group__input" id="${pt1.id}ColorHex" value="${newsletterData.design.propertyTypeColors[pt1.colorKey]}" oninput="handleColorHexChange('${pt1.id}Color', '${pt1.id}Color', this.value)" style="flex: 1; font-family: monospace;">
                                </div>
                            </div>
                        `;
                    }
                    
                    if (pt2) {
                        rowHtml += `
                            <div class="form-group">
                                <label class="form-group__label">${pt2.icon} ${pt2.name}</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="color" class="form-group__input" id="${pt2.id}Color" value="${newsletterData.design.propertyTypeColors[pt2.colorKey]}" onchange="handleFormChange('${pt2.id}Color', this.value)" style="width: 50px; padding: 2px;">
                                    <input type="text" class="form-group__input" id="${pt2.id}ColorHex" value="${newsletterData.design.propertyTypeColors[pt2.colorKey]}" oninput="handleColorHexChange('${pt2.id}Color', '${pt2.id}Color', this.value)" style="flex: 1; font-family: monospace;">
                                </div>
                            </div>
                        `;
                    } else {
                        rowHtml += '<div class="form-group"></div>'; // Empty cell for single item
                    }
                    
                    rowHtml += '</div>';
                    rows.push(rowHtml);
                }
                
                // Add custom property types color section
                const customPropertyTypeHtml = `
                    <div style="margin-top: 15px;">
                        <div class="form-group">
                            <label class="form-group__label">Custom Property Types</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="color" class="form-group__input" id="customPropertyColor" value="${newsletterData.design.propertyTypeColors.custom}" onchange="handleFormChange('customPropertyColor', this.value)" style="width: 50px; padding: 2px;">
                                <input type="text" class="form-group__input" id="customPropertyColorHex" value="${newsletterData.design.propertyTypeColors.custom}" oninput="handleColorHexChange('customPropertyColor', 'customPropertyColor', this.value)" style="flex: 1; font-family: monospace;">
                            </div>
                            <small>Color used for all custom property types you add</small>
                        </div>
                    </div>
                `;
                
                colorInputsContainer.innerHTML = rows.join('') + customPropertyTypeHtml;
            }
        }

        // Month display update
        function updateMonthDisplay() {
            const month = newsletterData.content.newsletterSeason || 'june';
            const monthName = month.charAt(0).toUpperCase() + month.slice(1);
            document.getElementById('currentMonth').textContent = `${monthName} 2025 Edition`;
        }

        // Get maintenance tips
        function getMaintenanceTips(config) {
            // Use the editable maintenance tips from newsletterData
            return newsletterData.maintenanceTips || config.tips;
        }

        // Maintenance tips management functions
        function renderMaintenanceTipsSummary() {
            const container = document.getElementById('maintenanceTipsSummary');
            
            if (!newsletterData.maintenanceTips || newsletterData.maintenanceTips.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 15px; color: var(--text-muted); font-style: italic; font-size: 14px;">
                        No maintenance tips added yet
                    </div>
                `;
                return;
            }
            
            const tipCount = newsletterData.maintenanceTips.length;
            const firstFewTips = newsletterData.maintenanceTips.slice(0, 3);
            
            container.innerHTML = `
                <div style="margin-bottom: 10px;">
                    <strong style="color: var(--primary-color);">${tipCount} Maintenance Tip${tipCount !== 1 ? 's' : ''}</strong>
                </div>
                <div style="font-size: 13px; line-height: 1.4;">
                    ${firstFewTips.map(tip => `<div style="margin-bottom: 5px; color: var(--text-muted);">${tip}</div>`).join('')}
                    ${tipCount > 3 ? `<div style="color: var(--text-secondary); font-style: italic; margin-top: 8px;">...and ${tipCount - 3} more tip${tipCount - 3 !== 1 ? 's' : ''}</div>` : ''}
                </div>
            `;
        }

        function renderModalMaintenanceTips() {
            const container = document.getElementById('modalMaintenanceTipsList');
            
            if (!newsletterData.maintenanceTips || newsletterData.maintenanceTips.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-muted); font-style: italic; font-size: 14px;">
                        No maintenance tips added yet
                    </div>
                `;
                return;
            }
            
            container.innerHTML = newsletterData.maintenanceTips.map((tip, index) => `
                <div class="event-item" style="margin-bottom: 10px; padding: 15px;">
                    <button class="event-delete" onclick="deleteModalMaintenanceTip(${index})" title="Delete tip" style="width: 25px; height: 25px; min-width: 25px; min-height: 25px;">×</button>
                    <div style="padding-right: 35px;">
                        <input type="text" value="${tip}" onchange="updateModalMaintenanceTip(${index}, this.value)" onclick="this.select()" style="width: 100%; background: transparent; border: 1px solid transparent; padding: 5px; border-radius: 4px; font-size: 14px; color: var(--text-light);" onmouseover="this.style.border='1px solid var(--border-color)'" onmouseout="this.style.border='1px solid transparent'" onfocus="this.style.border='1px solid var(--primary-color)'">
                    </div>
                </div>
            `).join('');
        }

        function openMaintenanceTipsModal() {
            // Update the modal current month display
            const currentMonth = newsletterData.content.newsletterSeason;
            document.getElementById('modalCurrentMonth').textContent = currentMonth;
            
            // Render tips in modal
            renderModalMaintenanceTips();
            
            // Close any existing emoji picker
            document.getElementById('modalEmojiPicker').style.display = 'none';
            
            // Clear the input
            document.getElementById('modalNewMaintenanceTip').value = '';
            
            // Show modal
            modalManager.show('maintenanceTipsModal');
        }

        // Modal-specific emoji picker functions
        function toggleModalEmojiPicker() {
            const picker = document.getElementById('modalEmojiPicker');
            const isVisible = picker.style.display !== 'none';
            picker.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                // Focus the input field when opening emoji picker
                document.getElementById('modalNewMaintenanceTip').focus();
            }
        }

        function insertModalEmoji(emoji) {
            const input = document.getElementById('modalNewMaintenanceTip');
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const text = input.value;
            
            // Insert emoji at cursor position
            const newText = text.substring(0, start) + emoji + ' ' + text.substring(end);
            input.value = newText;
            
            // Set cursor position after the inserted emoji
            const newCursorPos = start + emoji.length + 1;
            input.setSelectionRange(newCursorPos, newCursorPos);
            input.focus();
            
            // Close emoji picker after selection
            document.getElementById('modalEmojiPicker').style.display = 'none';
            
            showToast(`Added ${emoji} emoji`, 'success', 1500);
        }

        function addModalMaintenanceTip() {
            const input = document.getElementById('modalNewMaintenanceTip');
            const tip = input.value.trim();
            
            if (!tip) {
                showToast('❌ Please enter a tip', 'error');
                return;
            }
            
            // Ensure the tip starts with an emoji if it doesn't already
            const formattedTip = tip.match(/^[\u{1F300}-\u{1F9FF}]|^[\u{2600}-\u{27BF}]/u) ? tip : `🔧 ${tip}`;
            
            if (!newsletterData.maintenanceTips) {
                newsletterData.maintenanceTips = [];
            }
            
            newsletterData.maintenanceTips.push(formattedTip);
            input.value = '';
            
            // Close emoji picker
            document.getElementById('modalEmojiPicker').style.display = 'none';
            
            renderModalMaintenanceTips();
            renderMaintenanceTipsSummary(); // Update the summary too
            updatePreview();
            showToast('✅ Maintenance tip added!', 'success');
        }

        function updateModalMaintenanceTip(index, newTip) {
            if (newsletterData.maintenanceTips && newsletterData.maintenanceTips[index] !== undefined) {
                newsletterData.maintenanceTips[index] = newTip.trim();
                renderMaintenanceTipsSummary(); // Update the summary
                updatePreview();
                showToast('✅ Tip updated', 'success', 2000);
            }
        }

        function deleteModalMaintenanceTip(index) {
            if (confirm('Are you sure you want to delete this maintenance tip?')) {
                newsletterData.maintenanceTips.splice(index, 1);
                renderModalMaintenanceTips();
                renderMaintenanceTipsSummary(); // Update the summary
                updatePreview();
                showToast('✅ Maintenance tip deleted', 'success');
            }
        }

        function resetToDefaultTips() {
            const season = newsletterData.content.newsletterSeason;
            const config = SEASONS[season];
            
            if (confirm(`Are you sure you want to reset to the default ${season} maintenance tips? This will remove all your custom tips.`)) {
                newsletterData.maintenanceTips = [...config.tips];
                renderModalMaintenanceTips(); // Update modal if open
                renderMaintenanceTipsSummary(); // Update summary
                updatePreview();
                showToast('🔄 Reset to default seasonal tips', 'success');
            }
        }

        // Update maintenance tips when season changes
        function updateMaintenanceTipsForSeason(season) {
            const config = SEASONS[season];
            if (config && config.tips) {
                // Only update if no custom tips exist, or if user wants to reset
                if (!newsletterData.maintenanceTips || newsletterData.maintenanceTips.length === 0) {
                    newsletterData.maintenanceTips = [...config.tips];
                }
                renderMaintenanceTipsSummary(); // Update summary
            }
        }

        // Preview generation
        function updatePreview() {
            const season = newsletterData.content.newsletterSeason;
            const config = SEASONS[season];
            const colors = newsletterData.design.colors;
            const buttonColors = newsletterData.design.buttonColors;
            
            // Generate enabled smart buttons
            const enabledButtons = [];
            const buttons = newsletterData.agent.smartButtons;
            
            if (buttons.buyersGuide.url) {
                enabledButtons.push({
                    name: buttons.buyersGuide.name || 'Button 1',
                    url: buttons.buyersGuide.url,
                    color: buttonColors.buyersGuide,
                    icon: '🔘'
                });
            }
            
            if (buttons.sellersGuide.url) {
                enabledButtons.push({
                    name: buttons.sellersGuide.name || 'Button 2',
                    url: buttons.sellersGuide.url,
                    color: buttonColors.sellersGuide,
                    icon: '🔘'
                });
            }
            
            if (buttons.website.url) {
                enabledButtons.push({
                    name: buttons.website.name || 'Button 3',
                    url: buttons.website.url,
                    color: buttonColors.website,
                    icon: '🔘'
                });
            }
            
            if (buttons.blog.url) {
                enabledButtons.push({
                    name: buttons.blog.name || 'Button 4',
                    url: buttons.blog.url,
                    color: buttonColors.blog,
                    icon: '🔘'
                });
            }
            
            // Generate smart button HTML based on number of enabled buttons
            let buttonsHtml = '';
            if (enabledButtons.length > 0) {
                // Determine grid layout based on number of buttons
                let gridCols = '1fr';
                if (enabledButtons.length === 2) {
                    gridCols = '1fr 1fr';
                } else if (enabledButtons.length === 3) {
                    gridCols = '1fr 1fr 1fr';
                } else if (enabledButtons.length >= 4) {
                    gridCols = '1fr 1fr';
                }
                
                // Split smart buttons into rows if more than 4
                const smartButtonRows = [];
                for (let i = 0; i < enabledButtons.length; i += (enabledButtons.length > 4 ? 2 : enabledButtons.length)) {
                    smartButtonRows.push(enabledButtons.slice(i, i + (enabledButtons.length > 4 ? 2 : enabledButtons.length)));
                }
                
                buttonsHtml = `
                    <div style="max-width: 600px; margin: 40px auto 0; padding: 0 20px;">
                        ${smartButtonRows.map(row => `
                            <div style="display: grid; grid-template-columns: ${row.length === 1 ? '1fr' : '1fr 1fr'}; gap: 15px; margin-bottom: 15px;">
                                ${row.map(button => `
                                    <a href="${button.url}" style="display: block; background: ${button.color}; color: white; padding: 12px 16px; text-decoration: none; border-radius: 6px; font-weight: 600; font-size: 13px; text-align: center; text-transform: uppercase; letter-spacing: 0.5px;" target="_blank">
                                        ${button.icon} ${button.name}
                                    </a>
                                `).join('')}
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            const template = `
                <div style="max-width: 650px; margin: 0 auto; background: white; font-family: ${newsletterData.design.bodyFont}; color: ${colors.bodyText};">
                    <div style="text-align: center; padding: 40px 20px 30px;">
                        ${generateBannerHtml()}
                        
                        <div style="text-align: center; margin: 30px 0;">
                            <div style="font-family: ${newsletterData.design.headerFont}; font-size: 28px; font-weight: 300; color: ${colors.headerText};">${newsletterData.content.customSubtitle || config.subtitle}</div>
                        </div>
                        
                        <div style="max-width: 500px; margin: 40px auto 30px auto; text-align: center; padding: 25px; background: ${colors.background}; border-left: 4px solid ${colors.accent}; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                            <p style="font-size: 16px; line-height: 1.8; color: ${colors.bodyText}; margin: 0; font-weight: 400; font-style: italic;">${newsletterData.content.personalMessage}</p>
                        </div>
                        
                        ${buttonsHtml}
                    </div>
                    
                    <div style="height: 1px; background: #e0e0e0; margin: 0 40px;"></div>
                    ${generateMarketStatsHtml()}
                    
                    ${newsletterData.customEvents && newsletterData.customEvents.length > 0 ? `
                    <div style="height: 1px; background: #e0e0e0; margin: 0 40px;"></div>
                    <div style="padding: 40px;">
                        <h2 style="font-family: ${newsletterData.design.headerFont}; font-size: 24px; font-weight: 400; text-align: center; margin-bottom: 30px; color: ${colors.headerText};">Community CALENDAR</h2>
                        <div style="display: grid; gap: 20px;">
                            ${newsletterData.customEvents
                                .sort((a, b) => new Date(a.date) - new Date(b.date))
                                .map(event => `
                                <div style="display: grid; grid-template-columns: 100px 1fr ${event.image ? '150px' : ''}; gap: 20px; align-items: center; padding: 20px; border: 1px solid #f0f0f0; border-radius: 8px; background: #fafafa;">
                                    <div style="text-align: center;">
                                        <div style="background: ${colors.accent}; color: white; padding: 8px; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; border-radius: 4px;">${formatEventDate(event.date).month}</div>
                                        <div style="font-size: 24px; font-weight: 300; color: ${colors.headerText};">${formatEventDate(event.date).day}</div>
                                        ${event.startTime ? `<div style="font-size: 10px; color: ${colors.bodyText}; margin-top: 5px; line-height: 1.2;">${formatEventTime(event.startTime, event.endTime)}</div>` : ''}
                                    </div>
                                    <div>
                                        <h3 style="font-size: 16px; font-weight: 500; margin-bottom: 5px; color: ${colors.headerText};">${event.title}</h3>
                                        ${event.startTime ? `<p style="font-size: 13px; color: ${colors.bodyText}; margin: 0 0 5px 0;">🕐 ${formatEventTime(event.startTime, event.endTime)}</p>` : ''}
                                        ${event.location ? `<p style="font-size: 13px; color: ${colors.bodyText}; margin: 0 0 5px 0;">📍 ${event.location}</p>` : ''}
                                        ${event.description ? `<p style="font-size: 12px; color: #999; margin: 5px 0 0 0; font-style: italic; line-height: 1.4;">${event.description}</p>` : ''}
                                        ${event.detailsLink ? `
                                        <div style="margin-top: 15px;">
                                            <a href="${event.detailsLink}" style="display: inline-block; background: ${colors.accent}; color: white; padding: 8px 16px; text-decoration: none; border-radius: 5px; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;" target="_blank">
                                                📋 Event Details
                                            </a>
                                        </div>
                                        ` : ''}
                                    </div>
                                    ${event.image ? `
                                    <div style="text-align: center;">
                                        <img src="${event.image}" style="width: 140px; height: 100px; object-fit: cover; border-radius: 6px; border: 2px solid #e0e0e0;" alt="Event Image">
                                    </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    <div style="height: 1px; background: #e0e0e0; margin: 0 40px;"></div>
                    <div style="padding: 40px;">
                        <h2 style="font-family: ${newsletterData.design.headerFont}; font-size: 24px; font-weight: 400; text-align: center; margin-bottom: 30px; color: ${colors.headerText};">${newsletterData.content.newsletterSeason.charAt(0).toUpperCase() + newsletterData.content.newsletterSeason.slice(1)} Maintenance TIPS</h2>
                        <div style="background: ${colors.background}; padding: 30px; border-radius: 8px;">
                            <ul style="list-style: none; padding: 0; margin: 0;">
                                ${getMaintenanceTips(config).map(tip => `
                                    <li style="padding: 10px 0; border-bottom: 1px solid #e0e0e0; font-size: 14px; color: ${colors.bodyText};">${tip}</li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                    
                    <div style="background: ${colors.background}; padding: 40px; text-align: center;">
                        ${newsletterData.images.brokerageLogo ? `
                        <div style="margin-bottom: 30px;">
                            <img src="${newsletterData.images.brokerageLogo}" style="max-width: 200px; max-height: 80px; object-fit: contain;" alt="Brokerage Logo">
                        </div>
                        ` : ''}
                        
                        <div style="display: inline-flex; align-items: center; gap: 30px;">
                            <div style="width: 100px; height: 100px; border-radius: 50%; overflow: hidden; background: #e0e0e0;">
                                ${newsletterData.images.agentPhoto ? 
                                    `<img src="${newsletterData.images.agentPhoto}" style="width: 100%; height: 100%; object-fit: cover;" alt="Agent Photo">` :
                                    `<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #999; font-size: 12px;">Agent Photo</div>`
                                }
                            </div>
                            <div style="text-align: left;">
                                <h3 style="font-family: ${newsletterData.design.headerFont}; font-size: 22px; font-weight: 400; margin-bottom: 5px; color: ${colors.headerText};">${newsletterData.agent.name || 'Your Name'}</h3>
                                <p style="font-size: 13px; color: ${colors.bodyText}; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px;">${newsletterData.agent.company || 'Your Company'}</p>
                                <p style="font-size: 14px; margin: 5px 0; color: ${colors.bodyText};">📱 ${newsletterData.agent.phone || '(000) 000-0000'}</p>
                                <p style="font-size: 14px; margin: 5px 0; color: ${colors.bodyText};">✉️ ${newsletterData.agent.email || 'your@email.com'}</p>
                            </div>
                            ${newsletterData.images.agentLogo ? `
                            <div style="margin-left: 20px;">
                                <img src="${newsletterData.images.agentLogo}" style="max-width: 120px; max-height: 80px; object-fit: contain;" alt="Agent Logo">
                            </div>
                            ` : ''}
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <a href="http://${newsletterData.agent.website || 'www.yourwebsite.com'}" style="color: ${colors.accent}; text-decoration: none; font-size: 14px;">${newsletterData.agent.website || 'www.yourwebsite.com'}</a>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('newsletterPreview').innerHTML = template;
            updatePreviewStatus(); // Update the status text
        }

        // Banner generation
        function generateBannerHtml() {
            const bannerStyle = newsletterData.design.bannerStyle;
            const headerFont = newsletterData.design.headerFont;
            const colors = newsletterData.design.colors;
            const config = SEASONS[newsletterData.content.newsletterSeason];
            
            switch (bannerStyle) {
                case 'mountains':
                    return `
                        <div style="position: relative; margin: 40px 0 60px 0; padding: 50px 20px;">
                            <div style="position: relative; width: 600px; height: 300px; border-radius: 20px; overflow: hidden; background-image: url('https://i.imgur.com/0dARtuj.png'); background-size: cover; background-position: center; margin: 0 auto;">
                                <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3);"></div>
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 3;">
                                    <h1 style="font-family: ${headerFont}; font-size: 42px; font-weight: 400; letter-spacing: 4px; margin: 0; color: white; text-shadow: 0 4px 20px rgba(0,0,0,0.7);">${config.title}</h1>
                                </div>
                            </div>
                        </div>
                    `;

                case 'cityscape':
                    return `
                        <div style="position: relative; margin: 40px 0 60px 0; padding: 50px 20px;">
                            <div style="position: relative; width: 600px; height: 300px; border-radius: 20px; overflow: hidden; background-image: url('https://i.imgur.com/qok5dLZ.jpg'); background-size: cover; background-position: center; margin: 0 auto;">
                                <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3);"></div>
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 3;">
                                    <h1 style="font-family: ${headerFont}; font-size: 42px; font-weight: 400; letter-spacing: 4px; margin: 0; color: white; text-shadow: 0 4px 20px rgba(0,0,0,0.7);">${config.title}</h1>
                                </div>
                            </div>
                        </div>
                    `;

                case 'blueprint':
                    return `
                        <div style="position: relative; margin: 40px 0 60px 0; padding: 50px 20px;">
                            <div style="position: relative; width: 600px; height: 300px; border-radius: 20px; overflow: hidden; background-image: url('https://i.imgur.com/W24OelN.jpg'); background-size: cover; background-position: center; margin: 0 auto;">
                                <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3);"></div>
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 3;">
                                    <h1 style="font-family: ${headerFont}; font-size: 42px; font-weight: 400; letter-spacing: 4px; margin: 0; color: white; text-shadow: 0 4px 20px rgba(0,0,0,0.8);">${config.title}</h1>
                                </div>
                            </div>
                        </div>
                    `;

                case 'custom':
                    return `
                        <div style="position: relative; margin: 40px 0 60px 0; padding: 50px 20px;">
                            ${newsletterData.images.customBanner ? `
                            <div style="position: relative; width: 600px; height: 300px; border-radius: 20px; overflow: hidden; background-image: url('${newsletterData.images.customBanner}'); background-size: cover; background-position: center; margin: 0 auto;">
                                ${!newsletterData.design.hideCustomBannerText ? `
                                <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3);"></div>
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 3;">
                                    <h1 style="font-family: ${headerFont}; font-size: 42px; font-weight: 400; letter-spacing: 4px; margin: 0; color: white; text-shadow: 0 4px 20px rgba(0,0,0,0.7);">${config.title}</h1>
                                </div>
                                ` : ''}
                            </div>
                            ` : `
                            <div style="position: relative; width: 600px; height: 300px; border-radius: 20px; overflow: hidden; background: linear-gradient(135deg, ${colors.accent} 0%, ${colors.headerText} 50%, ${colors.accent} 100%); margin: 0 auto;">
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 3;">
                                    <h1 style="font-family: ${headerFont}; font-size: 42px; font-weight: 400; letter-spacing: 4px; margin: 0; color: white; text-shadow: 0 4px 20px rgba(0,0,0,0.5);">${config.title}</h1>
                                    <p style="color: white; font-size: 14px; margin-top: 10px; opacity: 0.9;">Upload custom banner image above</p>
                                </div>
                            </div>
                            `}
                        </div>
                    `;

                case 'minimal':
                    return `
                        <div style="text-align: center; margin: 40px 0; padding: 50px 20px;">
                            <div style="border-bottom: 2px solid ${colors.accent}; display: inline-block; margin-bottom: 40px; padding-bottom: 10px;">
                                <h1 style="font-family: ${headerFont}; font-size: 36px; font-weight: 300; letter-spacing: 3px; margin: 0; color: ${colors.headerText};">${config.title}</h1>
                            </div>
                        </div>
                    `;

                case 'none':
                    return `
                        <div style="text-align: center; margin: 40px 0; padding: 20px;">
                            <h1 style="font-family: ${headerFont}; font-size: 36px; font-weight: 400; letter-spacing: 3px; margin: 0; color: ${colors.headerText};">${config.title}</h1>
                        </div>
                    `;

                default:
                    return `
                        <div style="text-align: center; margin: 40px 0;">
                            <h1 style="font-family: ${headerFont}; font-size: 36px; font-weight: 400; letter-spacing: 3px; margin: 0; color: ${colors.headerText};">${config.title}</h1>
                        </div>
                    `;
            }
        }

        // Market stats generation
        function generateMarketStatsHtml() {
            const stats = newsletterData.stats;
            const headerFont = newsletterData.design.headerFont;
            const colors = newsletterData.design.colors;
            const propertyColors = newsletterData.design.propertyTypeColors;
            
            const currentMonth = newsletterData.content.newsletterSeason || 'june';
            const monthNames = ['january', 'february', 'march', 'april', 'may', 'june', 'july', 'august', 'september', 'october', 'november', 'december'];
            const currentIndex = monthNames.indexOf(currentMonth);
            const previousIndex = currentIndex === 0 ? 11 : currentIndex - 1;
            const previousMonth = monthNames[previousIndex].charAt(0).toUpperCase() + monthNames[previousIndex].slice(1);
            
            // Get active property types
            const activePropertyTypes = newsletterData.design.defaultPropertyTypes.filter(pt => !pt.deleted);
            
            let propertyTypeSections = '';
            
            // Generate sections for each active property type
            activePropertyTypes.forEach(propertyType => {
                const ptStats = newsletterData.stats;
                const colorKey = propertyType.colorKey || propertyType.id;
                const color = propertyColors[colorKey] || propertyColors.detached;
                
                propertyTypeSections += `
                    <!-- ${propertyType.name} -->
                    <div style="margin-bottom: 25px; border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden;">
                        <div style="background: ${color}; color: white; padding: 12px 20px; font-weight: 600; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">
                            ${propertyType.icon} ${propertyType.name}
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0;">
                            <div style="text-align: center; padding: 15px; border-right: 1px solid #e0e0e0; background: white;">
                                <div style="font-size: 18px; font-weight: 600; color: ${colors.headerText}; margin-bottom: 3px;">${ptStats[propertyType.id + 'Price'] || 'N/A'}</div>
                                <div style="font-size: 10px; color: ${colors.bodyText}; text-transform: uppercase; margin-bottom: 3px;">Price</div>
                                <div style="font-size: 12px; font-weight: 500; color: ${ptStats[propertyType.id + 'Change'] && ptStats[propertyType.id + 'Change'].startsWith('-') ? '#dc3545' : '#27ae60'};">${ptStats[propertyType.id + 'Change'] || 'N/A'}</div>
                            </div>
                            <div style="text-align: center; padding: 15px; border-right: 1px solid #e0e0e0; background: white;">
                                <div style="font-size: 18px; font-weight: 600; color: ${colors.headerText}; margin-bottom: 3px;">${ptStats[propertyType.id + 'Sales'] || 'N/A'}</div>
                                <div style="font-size: 10px; color: ${colors.bodyText}; text-transform: uppercase; margin-bottom: 3px;">Sales</div>
                                <div style="font-size: 12px; font-weight: 500; color: ${ptStats[propertyType.id + 'SalesChange'] && ptStats[propertyType.id + 'SalesChange'].startsWith('-') ? '#dc3545' : '#27ae60'};">${ptStats[propertyType.id + 'SalesChange'] || 'N/A'}</div>
                            </div>
                            <div style="text-align: center; padding: 15px; border-right: 1px solid #e0e0e0; background: white;">
                                <div style="font-size: 18px; font-weight: 600; color: ${colors.headerText}; margin-bottom: 3px;">${ptStats[propertyType.id + 'Listings'] || 'N/A'}</div>
                                <div style="font-size: 10px; color: ${colors.bodyText}; text-transform: uppercase; margin-bottom: 3px;">Listings</div>
                                <div style="font-size: 12px; font-weight: 500; color: ${ptStats[propertyType.id + 'ListingsChange'] && ptStats[propertyType.id + 'ListingsChange'].startsWith('-') ? '#dc3545' : '#27ae60'};">${ptStats[propertyType.id + 'ListingsChange'] || 'N/A'}</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: white;">
                                <div style="font-size: 18px; font-weight: 600; color: ${colors.headerText}; margin-bottom: 3px;">${ptStats[propertyType.id + 'Supply'] || 'N/A'}</div>
                                <div style="font-size: 10px; color: ${colors.bodyText}; text-transform: uppercase; margin-bottom: 3px;">Months Supply</div>
                                <div style="font-size: 12px; font-weight: 500; color: ${colors.bodyText};">mo</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            return `
                <div style="padding: 40px;">
                    <h2 style="font-family: ${headerFont}; font-size: 24px; font-weight: 400; text-align: center; margin-bottom: 30px; color: ${colors.headerText};">Snapshot of ${previousMonth} STATISTICS</h2>
                    
                    <!-- Main Market Overview -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px;">
                        <div style="text-align: center; padding: 20px; background: ${colors.background}; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: 600; color: ${colors.accent}; margin-bottom: 5px;">${stats.avgPrice}</div>
                            <div style="font-size: 12px; color: ${colors.bodyText}; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px;">Total Residential Price</div>
                            <div style="font-size: 14px; font-weight: 500; color: ${stats.priceChange && stats.priceChange.startsWith('-') ? '#dc3545' : '#27ae60'};">${stats.priceChange} Y/Y</div>
                        </div>
                        <div style="text-align: center; padding: 20px; background: ${colors.background}; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: 600; color: ${colors.headerText}; margin-bottom: 5px;">${stats.homesSold}</div>
                            <div style="font-size: 12px; color: ${colors.bodyText}; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px;">Sales</div>
                            <div style="font-size: 14px; font-weight: 500; color: ${stats.salesChange && stats.salesChange.startsWith('-') ? '#dc3545' : '#27ae60'};">${stats.salesChange || 'N/A'} Y/Y</div>
                        </div>
                        <div style="text-align: center; padding: 20px; background: ${colors.background}; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: 600; color: ${propertyColors.row}; margin-bottom: 5px;">${stats.newListings}</div>
                            <div style="font-size: 12px; color: ${colors.bodyText}; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px;">New Listings</div>
                            <div style="font-size: 14px; font-weight: 500; color: ${stats.listingsChange && stats.listingsChange.startsWith('-') ? '#dc3545' : '#27ae60'};">${stats.listingsChange || 'N/A'} Y/Y</div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 40px;">
                        <div style="text-align: center; padding: 20px; background: ${colors.background}; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: 600; color: ${propertyColors.apartment}; margin-bottom: 5px;">${stats.inventory}</div>
                            <div style="font-size: 12px; color: ${colors.bodyText}; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px;">Total Inventory</div>
                            <div style="font-size: 14px; font-weight: 500; color: ${stats.inventoryChange && stats.inventoryChange.startsWith('-') ? '#dc3545' : '#27ae60'};">${stats.inventoryChange || 'N/A'} Y/Y</div>
                        </div>
                        <div style="text-align: center; padding: 20px; background: ${colors.background}; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: 600; color: ${propertyColors.semi}; margin-bottom: 5px;">${stats.monthsOfSupply || 'N/A'}</div>
                            <div style="font-size: 12px; color: ${colors.bodyText}; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px;">Months of Supply</div>
                            <div style="font-size: 14px; font-weight: 500; color: ${stats.supplyChange && stats.supplyChange.startsWith('-') ? '#dc3545' : '#27ae60'};">${stats.supplyChange || 'Balanced'}</div>
                        </div>
                    </div>

                    <!-- Property Type Breakdown -->
                    ${activePropertyTypes.length > 0 ? `<h3 style="font-family: ${headerFont}; font-size: 20px; font-weight: 400; text-align: center; margin: 30px 0 25px 0; color: ${colors.headerText};">Property Type Breakdown</h3>` : ''}
                    
                    ${propertyTypeSections}

                    <!-- Custom Property Types -->
                    ${newsletterData.customPropertyTypes && newsletterData.customPropertyTypes.length > 0 ? 
                        newsletterData.customPropertyTypes.map(propertyType => `
                        <div style="margin-bottom: 25px; border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden;">
                            <div style="background: ${propertyColors.custom}; color: white; padding: 12px 20px; font-weight: 600; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">
                                ${propertyType.icon} ${propertyType.name}
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0;">
                                <div style="text-align: center; padding: 15px; border-right: 1px solid #e0e0e0; background: white;">
                                    <div style="font-size: 18px; font-weight: 600; color: ${colors.headerText}; margin-bottom: 3px;">${propertyType.stats.price || 'N/A'}</div>
                                    <div style="font-size: 10px; color: ${colors.bodyText}; text-transform: uppercase; margin-bottom: 3px;">Price</div>
                                    <div style="font-size: 12px; font-weight: 500; color: ${propertyType.stats.priceChange && propertyType.stats.priceChange.startsWith('-') ? '#dc3545' : '#27ae60'};">${propertyType.stats.priceChange || 'N/A'}</div>
                                </div>
                                <div style="text-align: center; padding: 15px; border-right: 1px solid #e0e0e0; background: white;">
                                    <div style="font-size: 18px; font-weight: 600; color: ${colors.headerText}; margin-bottom: 3px;">${propertyType.stats.sales || 'N/A'}</div>
                                    <div style="font-size: 10px; color: ${colors.bodyText}; text-transform: uppercase; margin-bottom: 3px;">Sales</div>
                                    <div style="font-size: 12px; font-weight: 500; color: ${propertyType.stats.salesChange && propertyType.stats.salesChange.startsWith('-') ? '#dc3545' : '#27ae60'};">${propertyType.stats.salesChange || 'N/A'}</div>
                                </div>
                                <div style="text-align: center; padding: 15px; border-right: 1px solid #e0e0e0; background: white;">
                                    <div style="font-size: 18px; font-weight: 600; color: ${colors.headerText}; margin-bottom: 3px;">${propertyType.stats.listings || 'N/A'}</div>
                                    <div style="font-size: 10px; color: ${colors.bodyText}; text-transform: uppercase; margin-bottom: 3px;">Listings</div>
                                    <div style="font-size: 12px; font-weight: 500; color: ${propertyType.stats.listingsChange && propertyType.stats.listingsChange.startsWith('-') ? '#dc3545' : '#27ae60'};">${propertyType.stats.listingsChange || 'N/A'}</div>
                                </div>
                                <div style="text-align: center; padding: 15px; background: white;">
                                    <div style="font-size: 18px; font-weight: 600; color: ${colors.headerText}; margin-bottom: 3px;">${propertyType.stats.supply || 'N/A'}</div>
                                    <div style="font-size: 10px; color: ${colors.bodyText}; text-transform: uppercase; margin-bottom: 3px;">Months Supply</div>
                                    <div style="font-size: 12px; font-weight: 500; color: ${colors.bodyText};">mo</div>
                                </div>
                            </div>
                        </div>
                        `).join('') : ''
                    }
                    
                    ${newsletterData.content.marketButtonText ? `
                    <div style="text-align: center; margin-top: 30px;">
                        <a href="${newsletterData.content.marketButtonUrl || '#'}" style="display: inline-block; background: ${newsletterData.design.buttonColors.marketReport}; color: white; padding: 15px 30px; text-decoration: none; border-radius: 6px; font-weight: 600; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;" target="_blank">${newsletterData.content.marketButtonText}</a>
                    </div>
                    ` : ''}
                </div>
            `;
        }

        // Update events list
        function updateEventsList() {
            const container = document.getElementById('customEventsList');
            
            if (!newsletterData.customEvents || newsletterData.customEvents.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-muted); font-style: italic; font-size: 14px;">
                        No events added yet
                    </div>
                `;
                return;
            }
            
            const sortedEvents = newsletterData.customEvents
                .sort((a, b) => new Date(a.date) - new Date(b.date));
            
            container.innerHTML = sortedEvents.map(event => `
                <div class="event-item" style="margin-top: 10px;">
                    <button class="event-delete" onclick="deleteEvent('${event.id}')" title="Delete event">×</button>
                    <div style="display: flex; gap: 15px; align-items: flex-start;">
                        ${event.image ? `
                        <div style="flex-shrink: 0;">
                            <img src="${event.image}" style="width: 60px; height: 45px; object-fit: cover; border-radius: 4px; border: 1px solid var(--border-color);" alt="Event">
                        </div>
                        ` : ''}
                        <div style="flex: 1; min-width: 0;">
                            <h4 style="font-size: 14px; font-weight: 600; margin: 0 0 5px 0; color: var(--text-light);">
                                ${event.title}
                                ${event.detailsLink ? '<span style="color: var(--primary-color); font-size: 12px; margin-left: 5px;">🔗</span>' : ''}
                            </h4>
                            <p style="font-size: 12px; color: var(--text-muted); margin: 0 0 3px 0;">📅 ${formatEventDate(event.date).month} ${formatEventDate(event.date).day}${event.startTime ? ` • ${formatEventTime(event.startTime, event.endTime)}` : ''}</p>
                            ${event.location ? `<p style="font-size: 12px; color: var(--text-muted); margin: 0;">📍 ${event.location}</p>` : ''}
                            ${event.description ? `<p style="font-size: 11px; color: var(--text-muted); margin: 5px 0 0 0; font-style: italic;">${event.description.length > 60 ? event.description.substring(0, 60) + '...' : event.description}</p>` : ''}
                            ${event.detailsLink ? `<p style="font-size: 11px; color: var(--primary-color); margin: 3px 0 0 0;">🔗 Details link available</p>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function deleteEvent(eventId) {
            if (confirm('Are you sure you want to delete this event?')) {
                newsletterData.customEvents = newsletterData.customEvents.filter(event => event.id !== eventId);
                updateEventsList();
                updatePreview();
                showToast('✅ Event deleted successfully', 'success');
            }
        }

        // Add custom property type functionality
        function addCustomPropertyType(name, icon = '🏘️') {
            const newPropertyType = {
                id: Date.now().toString(),
                name: name,
                icon: icon || '🏘️',
                stats: {
                    price: '',
                    priceChange: '',
                    sales: '',
                    salesChange: '',
                    listings: '',
                    listingsChange: '',
                    supply: ''
                }
            };
            
            newsletterData.customPropertyTypes.push(newPropertyType);
            renderCustomPropertyTypes();
            updatePreview();
            showToast('✅ Custom property type added!', 'success');
        }

        function renderCustomPropertyTypes() {
            const container = document.getElementById('customPropertyTypesContainer');
            
            if (!newsletterData.customPropertyTypes || newsletterData.customPropertyTypes.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = newsletterData.customPropertyTypes.map(propertyType => `
                <div style="margin-bottom: 25px;">
                    <div class="stats-section-header" style="display: flex; align-items: center; justify-content: space-between;">
                        <span>${propertyType.icon} ${propertyType.name}</span>
                        <button onclick="deleteCustomPropertyType('${propertyType.id}')" style="background: var(--danger-color); color: white; border: none; border-radius: 4px; padding: 4px 8px; font-size: 11px; cursor: pointer;">Delete</button>
                    </div>
                    <div class="stat-item" style="margin-bottom: 8px;">
                        <label class="stat-item__label">Price</label>
                        <input type="text" class="stat-item__input" value="${propertyType.stats.price}" oninput="updateCustomPropertyTypeStat('${propertyType.id}', 'price', this.value)">
                    </div>
                    <div class="stat-item" style="margin-bottom: 8px;">
                        <label class="stat-item__label">Price Change Y/Y</label>
                        <input type="text" class="stat-item__input" value="${propertyType.stats.priceChange}" oninput="updateCustomPropertyTypeStat('${propertyType.id}', 'priceChange', this.value)">
                    </div>
                    <div class="stat-item" style="margin-bottom: 8px;">
                        <label class="stat-item__label">Sales</label>
                        <input type="text" class="stat-item__input" value="${propertyType.stats.sales}" oninput="updateCustomPropertyTypeStat('${propertyType.id}', 'sales', this.value)">
                    </div>
                    <div class="stat-item" style="margin-bottom: 8px;">
                        <label class="stat-item__label">Sales Change Y/Y</label>
                        <input type="text" class="stat-item__input" value="${propertyType.stats.salesChange}" oninput="updateCustomPropertyTypeStat('${propertyType.id}', 'salesChange', this.value)">
                    </div>
                    <div class="stat-item" style="margin-bottom: 8px;">
                        <label class="stat-item__label">New Listings</label>
                        <input type="text" class="stat-item__input" value="${propertyType.stats.listings}" oninput="updateCustomPropertyTypeStat('${propertyType.id}', 'listings', this.value)">
                    </div>
                    <div class="stat-item" style="margin-bottom: 8px;">
                        <label class="stat-item__label">Listings Change Y/Y</label>
                        <input type="text" class="stat-item__input" value="${propertyType.stats.listingsChange}" oninput="updateCustomPropertyTypeStat('${propertyType.id}', 'listingsChange', this.value)">
                    </div>
                    <div class="stat-item" style="margin-bottom: 8px;">
                        <label class="stat-item__label">Months Supply</label>
                        <input type="text" class="stat-item__input" value="${propertyType.stats.supply}" oninput="updateCustomPropertyTypeStat('${propertyType.id}', 'supply', this.value)">
                    </div>
                </div>
            `).join('');
        }

        function updateCustomPropertyTypeStat(propertyTypeId, statKey, value) {
            const propertyType = newsletterData.customPropertyTypes.find(pt => pt.id === propertyTypeId);
            if (propertyType) {
                propertyType.stats[statKey] = value;
                updatePreview();
            }
        }

        function deleteCustomPropertyType(propertyTypeId) {
            if (confirm('Are you sure you want to delete this custom property type?')) {
                newsletterData.customPropertyTypes = newsletterData.customPropertyTypes.filter(pt => pt.id !== propertyTypeId);
                renderCustomPropertyTypes();
                updatePreview();
                showToast('✅ Custom property type deleted', 'success');
            }
        }

        // Custom Property Type emoji picker functions
        function toggleCustomPropertyEmojiPicker() {
            const picker = document.getElementById('customPropertyEmojiPicker');
            const isVisible = picker.style.display !== 'none';
            picker.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                // Focus the input field when opening emoji picker
                document.getElementById('customPropertyTypeIcon').focus();
            }
        }

        function insertCustomPropertyEmoji(emoji) {
            const input = document.getElementById('customPropertyTypeIcon');
            input.value = emoji;
            input.focus();
            
            // Close emoji picker after selection
            document.getElementById('customPropertyEmojiPicker').style.display = 'none';
            
            showToast(`Selected ${emoji} for property type`, 'success', 1500);
        }

        // Toggle instructions popup
        function toggleInstructionsPopup() {
            const popup = document.getElementById('instructionsPopup');
            const isVisible = popup.style.display !== 'none';
            popup.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                // Add a smooth slide-in animation
                popup.style.animation = 'fadeInUp 0.3s ease forwards';
            }
        }

        // Update preview status
        function updatePreviewStatus() {
            const statusEl = document.getElementById('previewStatus');
            const hasName = newsletterData.agent.name.trim();
            const hasMessage = newsletterData.content.personalMessage.trim();
            const hasStats = newsletterData.stats.avgPrice || newsletterData.stats.homesSold;
            
            if (hasName && hasMessage && hasStats) {
                statusEl.textContent = '✅ Your newsletter is ready! Use Export Options below to share it.';
                statusEl.style.color = 'var(--success-color)';
            } else if (hasMessage || hasName) {
                statusEl.textContent = 'Instructions to build a custom Newsletter';
                statusEl.style.color = 'var(--primary-color)';
            } else {
                statusEl.textContent = '📝 Start filling out the form to see your newsletter preview';
                statusEl.style.color = 'var(--text-muted)';
            }
        }

        // Quick print function
        function quickPrint() {
            window.scrollTo(0, 0);
            showToast('🖨️ Opening print dialog...', 'info', 2000);
            setTimeout(() => {
                window.print();
            }, 100);
        }

        // Utility functions
        function generateNewsletter() {
            updatePreview();
            showToast('✨ Newsletter generated successfully!', 'success');
        }

        function getFullHTML() {
            const newsletterHtml = document.getElementById('newsletterPreview').innerHTML;
            return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Estate Newsletter - ${newsletterData.content.newsletterSeason.charAt(0).toUpperCase() + newsletterData.content.newsletterSeason.slice(1)} 2025</title>
</head>
<body style="margin: 0; padding: 20px; background: #f5f5f5; font-family: Arial, sans-serif;">
    ${newsletterHtml}
</body>
</html>`;
        }

        // Export manager with email-safe HTML generation
        const exportManager = {
            copyEmailSafeHTML: () => {
                const html = getEmailSafeHTML();
                navigator.clipboard.writeText(html).then(() => {
                    modalManager.close('exportModal');
                    showToast('✅ Newsletter copied for email!', 'success', 6000);
                }).catch(() => {
                    showToast('❌ Failed to copy to clipboard', 'error');
                });
            },
            
            exportAsHTML: () => {
                const html = getEmailSafeHTML();
                const blob = new Blob([html], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `newsletter-${newsletterData.content.newsletterSeason}-2025-email-safe.html`;
                a.click();
                URL.revokeObjectURL(url);
                modalManager.close('exportModal');
                showToast('✅ Newsletter exported with email-safe tables!', 'success');
            },

            printNewsletter: () => {
                modalManager.close('exportModal');
                setTimeout(() => {
                    window.scrollTo(0, 0);
                    showToast('🖨️ Opening print dialog...', 'info', 2000);
                    window.print();
                }, 300);
            }
        };

        // Email-safe HTML generation using tables
        function getEmailSafeHTML() {
            const season = newsletterData.content.newsletterSeason;
            const config = SEASONS[season];
            const colors = newsletterData.design.colors;
            
            return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Estate Newsletter - ${season.charAt(0).toUpperCase() + season.slice(1)} 2025</title>
    <meta name="x-apple-disable-message-reformatting">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@300;400;500;600;700&family=Montserrat:wght@300;400;500;600;700&family=Crimson+Text:wght@400;600&family=Raleway:wght@300;400;500&family=Lora:wght@400;500&family=Cormorant+Garamond:wght@300;400;500&display=swap');
        
        body, table, td, div, p, a {
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
        }
        
        table, td {
            mso-table-lspace: 0pt;
            mso-table-rspace: 0pt;
        }
        
        img {
            -ms-interpolation-mode: bicubic;
            border: 0;
            height: auto;
            line-height: 100%;
            outline: none;
            text-decoration: none;
        }
        
        .ReadMsgBody { width: 100%; }
        .ExternalClass { width: 100%; }
        .ExternalClass, .ExternalClass p, .ExternalClass span, .ExternalClass font, .ExternalClass td, .ExternalClass div { line-height: 100%; }
        
        /* Custom colors */
        .header-text { color: ${colors.headerText} !important; }
        .body-text { color: ${colors.bodyText} !important; }
        .accent-color { color: ${colors.accent} !important; }
        .bg-accent { background-color: ${colors.background} !important; }
    </style>
</head>
<body style="margin: 0; padding: 0; background-color: #f5f5f5; font-family: ${newsletterData.design.bodyFont};">
    <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="100%" style="background-color: #f5f5f5;">
        <tr>
            <td align="center" style="padding: 20px;">
                <table role="presentation" cellspacing="0" cellpadding="0" border="0" width="650" style="max-width: 650px; background-color: white; margin: 0 auto;">
                    <tr>
                        <td style="padding: 40px 20px; font-family: ${newsletterData.design.bodyFont}; color: ${colors.bodyText};">
                            ${document.getElementById('newsletterPreview').innerHTML}
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
</body>
</html>`;
        }

        // Setup event listeners
        function setupEventListeners() {
            // Text inputs
            ['agentName', 'companyName', 'agentPhone', 'agentEmail', 'agentWebsite', 'personalMessage', 'customSubtitle', 'marketButtonText', 'marketButtonUrl', 'buyersGuideName', 'buyersGuideUrl', 'sellersGuideName', 'sellersGuideUrl', 'websiteName', 'myWebsiteUrl', 'blogName', 'blogUrl'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', (e) => handleFormChange(id, e.target.value));
                }
            });

            // Color inputs
            ['headerTextColor', 'bodyTextColor', 'accentColor', 'backgroundAccent', 'buyersGuideColor', 'sellersGuideColor', 'websiteColor', 'blogColor', 'marketButtonColor', 'detachedColor', 'semiColor', 'rowColor', 'apartmentColor', 'customPropertyColor'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', (e) => handleFormChange(id, e.target.value));
                }
            });

            // Color hex inputs
            ['headerTextColorHex', 'bodyTextColorHex', 'accentColorHex', 'backgroundAccentHex', 'buyersGuideColorHex', 'sellersGuideColorHex', 'websiteColorHex', 'blogColorHex', 'marketButtonColorHex', 'detachedColorHex', 'semiColorHex', 'rowColorHex', 'apartmentColorHex', 'customPropertyColorHex'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    const baseId = id.replace('Hex', '');
                    element.addEventListener('input', (e) => handleColorHexChange(baseId, baseId, e.target.value));
                }
            });

            // Select inputs
            ['bannerStyle', 'headerFont', 'bodyFont', 'newsletterSeason'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', (e) => handleFormChange(id, e.target.value));
                }
            });

            // Checkbox inputs
            ['hideCustomBannerText', 'buyersGuideEnabled', 'sellersGuideEnabled', 'websiteEnabled', 'blogEnabled'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', (e) => handleFormChange(id, e.target.checked));
                }
            });

            // Add custom property type form
            const addCustomPropertyTypeForm = document.getElementById('addCustomPropertyTypeForm');
            if (addCustomPropertyTypeForm) {
                addCustomPropertyTypeForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    
                    const name = document.getElementById('customPropertyTypeName').value.trim();
                    const icon = document.getElementById('customPropertyTypeIcon').value.trim();
                    
                    if (!name) {
                        showToast('❌ Please enter a property type name', 'error');
                        return;
                    }
                    
                    addCustomPropertyType(name, icon);
                    modalManager.close('addCustomPropertyTypeModal');
                });
            }
            const addEventForm = document.getElementById('addEventForm');
            if (addEventForm) {
                addEventForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    
                    const title = document.getElementById('eventTitle').value.trim();
                    const date = document.getElementById('eventDate').value;
                    const startTime = document.getElementById('eventStartTime').value;
                    const endTime = document.getElementById('eventEndTime').value;
                    const location = document.getElementById('eventLocation').value.trim();
                    const description = document.getElementById('eventDescription').value.trim();
                    const detailsLink = document.getElementById('eventDetailsLink').value.trim();
                    
                    if (!title || !date) {
                        showToast('❌ Please fill in Title and Date (required fields)', 'error');
                        return;
                    }
                    
                    // Validate URL if provided
                    if (detailsLink && !detailsLink.startsWith('http://') && !detailsLink.startsWith('https://')) {
                        showToast('❌ Event details link must start with http:// or https://', 'error');
                        return;
                    }
                    
                    // Validate end time is after start time
                    if (startTime && endTime && endTime <= startTime) {
                        showToast('❌ End time must be after start time', 'error');
                        return;
                    }
                    
                    if (!newsletterData.customEvents) {
                        newsletterData.customEvents = [];
                    }
                    
                    const newEvent = {
                        id: Date.now().toString(),
                        title,
                        date,
                        startTime,
                        endTime,
                        location,
                        description,
                        detailsLink,
                        image: newsletterData.images.currentEventImage
                    };
                    
                    newsletterData.customEvents.push(newEvent);
                    
                    // Reset the current event image
                    newsletterData.images.currentEventImage = null;
                    
                    showToast('✅ Event added successfully!', 'success');
                    modalManager.close('addEventModal');
                    updateEventsList();
                    updatePreview();
                });
            }

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    e.preventDefault();
                    generateNewsletter();
                }
            });

            // Close modal with escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    const openModal = document.querySelector('.modal-overlay--show');
                    if (openModal) {
                        modalManager.close(openModal.id);
                    }
                }
            });
        }

        // Animate elements on scroll
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.animation = 'fadeInUp 0.8s ease forwards';
                }
            });
        }, observerOptions);

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Initialize with proper seasonal maintenance tips
                const currentSeason = newsletterData.content.newsletterSeason;
                const seasonConfig = SEASONS[currentSeason];
                if (seasonConfig && seasonConfig.tips) {
                    newsletterData.maintenanceTips = [...seasonConfig.tips];
                }
                
                renderStats();
                updatePropertyTypeColorInputs(); // Initialize property type color inputs
                setupEventListeners();
                updateMonthDisplay();
                updateEventsList();
                renderMaintenanceTipsSummary(); // Initialize maintenance tips summary display
                updateColorInputs(); // Initialize color inputs with default values
                updatePreview();
                updatePreviewStatus(); // Initialize status text
                
                // Animate elements on scroll
                document.querySelectorAll('.fade-in').forEach(element => {
                    observer.observe(element);
                });
                
                showToast('🚀 Newsletter Builder Pro ready! Click the "?" button above for instructions!', 'success', 4000);
                
                console.log('💡 Newsletter Builder Pro:');
                console.log('• Click the "?" button in the preview area for step-by-step instructions');
                console.log('• Use Ctrl/Cmd + Enter to generate newsletter');
                console.log('• All images automatically uploaded to Imgur for email compatibility');
                console.log('• Export options include email-safe HTML with table layouts');
                console.log('• Print button optimized for professional paper output');
                console.log('• 🎨 Color customization organized by section with 9 preset themes including Royal LePage!');
                console.log('• 📐 Colors: Global design → Smart buttons → Property types');
                console.log('• 🏠 Property types: Click names to edit, use delete button to remove');
                console.log('• 🔗 Smart Buttons: Toggle on/off and customize names for each button');
                console.log('• 🔧 Maintenance tips: Modal interface with emoji picker, edit and delete capabilities');
                
            } catch (error) {
                console.error('Application initialization error:', error);
                showToast('⚠️ Application started with some limitations. Please refresh if you encounter issues.', 'warning', 6000);
            }
        });
    </script>
</body>
</html>
